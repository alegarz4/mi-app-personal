<!--
Mi App Personal (PWA)
Autor√≠a: Claudia Alejandra Garza Hernandez
¬© 2026 Claudia Alejandra Garza Hernandez. Todos los derechos reservados.
Prohibida la copia, modificaci√≥n o distribuci√≥n sin permiso por escrito.
-->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi App Personal ‚Äî Regulaci√≥n Emocional</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#7c3aed">
  <link rel="icon" href="icon.svg">

  <style>
    :root{
      --bg:#0b1020;
      --panel: rgba(255,255,255,0.07);
      --panel2: rgba(255,255,255,0.10);
      --border: rgba(255,255,255,0.14);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --muted2: rgba(255,255,255,0.55);
      --accent:#7c3aed;
      --ok:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
      --radius:18px;
      --shadow:0 10px 30px rgba(0,0,0,0.35);
      --max:1100px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(1100px 600px at 15% 0%, rgba(124,58,237,0.25), transparent 60%),
        radial-gradient(900px 500px at 85% 15%, rgba(34,197,94,0.18), transparent 60%),
        linear-gradient(180deg, #070a14, #0b1020);
      color:var(--text);
    }
    .wrap{ width:min(var(--max), calc(100% - 32px)); margin:0 auto; }
    header{
      position:sticky; top:0; z-index:30;
      backdrop-filter: blur(10px);
      background: rgba(10,14,28,0.65);
      border-bottom:1px solid var(--border);
    }
    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; padding:16px 0;
    }
    h1{ margin:0; font-size:22px; }
    .sub{ margin:4px 0 0; color:var(--muted); font-size:13px; }
    .status{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:999px;
      background:var(--panel); border:1px solid var(--border);
      font-size:13px; color:var(--muted);
    }
    .dot{ width:10px; height:10px; border-radius:999px; background:var(--ok);
      box-shadow:0 0 0 4px rgba(34,197,94,0.16);
    }

    main{
      padding:22px 0 40px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:16px;
    }
    .card{
      grid-column: span 6;
      background: linear-gradient(180deg, var(--panel), rgba(255,255,255,0.04));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .wide{ grid-column: span 12; }

    h2{ margin:2px 0 8px; font-size:18px; }
    h3{ margin:12px 0 8px; font-size:15px; color:var(--text); }
    .muted{ color:var(--muted); }
    .tiny{ font-size:12px; color:var(--muted2); }
    .row{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin-top:12px; flex-wrap:wrap;
    }
    .chips{ display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
    .chip{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:14px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .chip:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.09); }
    .chip.active{
      border-color: rgba(124,58,237,0.65);
      background: rgba(124,58,237,0.22);
    }

    .badge{
      padding:8px 12px; border-radius:999px;
      border:1px dashed rgba(255,255,255,0.28);
      background: rgba(255,255,255,0.05);
      color:var(--muted);
      font-size:13px;
    }

    /* Contraste mejorado */
    .input,.textarea,.select{
      width:100%; margin-top:6px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.08);
      color:var(--text);
      padding:12px;
      outline:none;
      font-size:14px;
    }
    .textarea{ resize:vertical; }
    .input:focus,.textarea:focus,.select:focus{
      border-color: rgba(124,58,237,0.65);
      box-shadow: 0 0 0 4px rgba(124,58,237,0.16);
    }
    .textarea::placeholder, .input::placeholder{
      color: rgba(255,255,255,0.45);
    }

    .btn{
      border:0;
      background: rgba(124,58,237,0.92);
      color:white;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:14px;
      transition: transform .08s ease, filter .2s ease;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    .btn:active{ transform: translateY(0); }
    .ghost{ background: rgba(255,255,255,0.06); border:1px solid var(--border); color:var(--text); }
    .danger{ background: rgba(239,68,68,0.92); }
    .warn{ background: rgba(245,158,11,0.92); }
    .ok{ background: rgba(34,197,94,0.92); }

    .divider{ margin:14px 0; height:1px; background: rgba(255,255,255,0.08); }

    .quote{
      margin:0;
      padding:12px 14px;
      border-left:3px solid rgba(124,58,237,0.75);
      background: rgba(255,255,255,0.05);
      border-radius:12px;
      color:var(--text);
      line-height:1.35;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }
    .item{
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      cursor:pointer;
      transition: transform .08s ease, background .2s ease;
    }
    .item:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.06); }
    .itemTop{ display:flex; justify-content:space-between; gap:10px; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      font-size:12px;
      color:var(--muted);
    }

    details{ margin-top:12px; border:1px solid rgba(255,255,255,0.10); border-radius:14px; padding:10px 12px; background: rgba(255,255,255,0.03); }
    summary{ cursor:pointer; color:var(--muted); font-size:13px; }
    pre{ overflow:auto; margin:10px 0 0; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.25); color: rgba(255,255,255,0.85); font-size:12px; }

    .grid2{ display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; }
    .stat{
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
    }
    .stat strong{ font-size:18px; display:block; }
    .stat span{ font-size:12px; color:var(--muted); }

    /* Slider */
    .rangeWrap{
      display:flex; align-items:center; gap:12px; margin-top:10px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      border-radius:14px;
      padding:10px 12px;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }
    .rangeVal{
      min-width:44px;
      text-align:center;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.20);
      color: var(--text);
      font-weight:700;
    }

    /* Modal */
    .overlay{
      position:fixed; inset:0; z-index:80;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
    }
    .modal{
      width:min(680px, 100%);
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(12,16,32,0.92);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modal h3{ margin:0 0 10px; }
    .modalActions{ display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; margin-top:12px; }
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .tab{
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
    }
    .tab.active{
      border-color: rgba(124,58,237,0.65);
      background: rgba(124,58,237,0.20);
    }

    /* Lock */
    .lockWrap{
      min-height: calc(100vh - 80px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:22px;
    }
    .lockCard{
      width:min(520px, 100%);
      background: linear-gradient(180deg, var(--panel), rgba(255,255,255,0.04));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      text-align:left;
    }

    footer{ padding:18px 0 28px; }

    /* FIX: Men√∫ desplegable visible en Chrome/Windows */
select option {
  background: #111827 !important;  /* fondo oscuro */
  color: #ffffff !important;       /* letras blancas */
}

    @media (max-width: 920px){
      .card{ grid-column: span 12; }
      .top{ flex-direction:column; align-items:flex-start; }
      .grid2{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap top">
      <div>
        <h1>Mi App Personal</h1>
        <p class="sub">Regulaci√≥n emocional: registrar, respirar, entender y avanzar (para todo, no para una sola historia).</p>
      </div>

      <<div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
  <button class="btn danger" id="emergencyBtn" type="button">üßØ Estoy muy mal</button>
  <button class="btn ghost" id="aboutBtn" type="button">‚ÑπÔ∏è Acerca de</button>
  <div class="status"><span class="dot"></span><span id="statusText">Listo</span></div>
</div>

    </div>
  </header>

  <!-- LOCK SCREEN -->
  <div class="lockWrap" id="lockWrap">
    <div class="lockCard">
      <h2>üîí App bloqueada</h2>
      <p class="muted">Ingresa tu PIN para abrir.</p>
      <input id="pinInput" class="input" type="password" inputmode="numeric" placeholder="PIN (solo n√∫meros)" />
      <div class="row">
        <button class="btn" id="unlockBtn" type="button">Desbloquear</button>
        <button class="btn ghost" id="lockHelpBtn" type="button">¬øOlvid√© mi PIN?</button>
        <button class="btn danger" id="lockRemovePinBtn" type="button">Quitar PIN (sin borrar historial)</button>
      </div>
      <p class="tiny" id="lockMsg">‚Äî</p>
      <details>
        <summary>Consejo r√°pido</summary>
        <p class="tiny muted">
          El PIN es un bloqueo simple. Si lo olvidas, este bot√≥n de emergencia lo quita sin borrar historial.
        </p>
      </details>
    </div>
  </div>

  <main class="wrap" id="appMain" style="display:none;">
    <!-- MOOD -->
    <section class="card">
      <h2>¬øC√≥mo me siento hoy?</h2>
      <p class="muted">Elige una opci√≥n (o cambia cuando lo necesites).</p>

      <div class="chips" role="group" aria-label="Selecci√≥n de estado emocional">
        <button class="chip" data-mood="Tranquila" type="button">Tranquila</button>
        <button class="chip" data-mood="Ansiosa" type="button">Ansiosa</button>
        <button class="chip" data-mood="Triste" type="button">Triste</button>
        <button class="chip" data-mood="Indiferente" type="button">Indiferente</button>
        <button class="chip" data-mood="Molesta" type="button">Molesta</button>
      </div>

      <div class="row">
        <div class="badge" id="moodBadge" style="min-width:220px; text-align:center;">Hoy: ‚Äî</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn warn" id="pauseBtn" type="button">Pausa 30s</button>
          <button class="btn ghost" id="clearMood" type="button">Limpiar</button>
        </div>
      </div>

      <div class="divider"></div>
      <p class="tiny muted">
        Tip: si est√°s ‚ÄúMolesta‚Äù o ‚ÄúAnsiosa‚Äù, usa ‚ÄúPausa 30s‚Äù antes de escribir. Baja la intensidad primero.
      </p>
    </section>

    <!-- THOUGHT -->
    <section class="card">
      <h2>¬øQu√© pensamiento domina?</h2>
      <p class="muted">Escr√≠belo tal cual. No es juicio, es registro.</p>

      <textarea id="thought" class="textarea" rows="5" placeholder="Ej. ‚ÄúMe siento en alerta‚Ä¶‚Äù o ‚ÄúNecesito descansar‚Ä¶‚Äù"></textarea>

      <div class="row">
        <button class="btn" id="saveThought" type="button">Guardar</button>
        <button class="btn ghost" id="clearThought" type="button">Limpiar</button>
      </div>

      <p class="tiny" id="thoughtSavedAt">‚Äî</p>
    </section>

    <!-- (1) INTENSIDAD + DETONANTE + NECESIDAD -->
    <section class="card wide">
      <h2>Chequeo r√°pido</h2>
      <p class="muted">Esto te ayuda a ver patrones: qu√© tan intenso fue, qu√© lo deton√≥ y qu√© necesitas.</p>

      <div class="grid2">
        <div>
          <label class="tiny">Intensidad (0‚Äì10)</label>
          <div class="rangeWrap">
            <input id="intensity" type="range" min="0" max="10" step="1" value="0" />
            <div class="rangeVal" id="intensityVal">0</div>
          </div>
          <p class="tiny muted" style="margin-top:8px;">
            0 = neutro / 10 = muy fuerte.
          </p>
        </div>

        <div>
          <label class="tiny">Detonante (¬øqu√© lo activ√≥?)</label>
          <select id="trigger" class="select">
            <option value="">‚Äî Elegir ‚Äî</option>
            <option value="Trabajo/escuela">Trabajo/escuela</option>
            <option value="Familia">Familia</option>
            <option value="Pareja/relaciones">Pareja/relaciones</option>
            <option value="Salud/cuerpo">Salud/cuerpo</option>
            <option value="Dinero">Dinero</option>
            <option value="Cansancio/sue√±o">Cansancio/sue√±o</option>
            <option value="Recuerdo/duelo">Recuerdo/duelo</option>
            <option value="Soledad">Soledad</option>
            <option value="Redes/noticias">Redes/noticias</option>
            <option value="Otro">Otro</option>
          </select>

          <div id="triggerOtherWrap" style="display:none; margin-top:10px;">
            <label class="tiny">Especifica ‚ÄúOtro‚Äù</label>
            <input id="triggerOther" class="input" type="text" placeholder="Ej. discusi√≥n, mensaje, presi√≥n, etc." />
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="grid2">
        <div>
          <label class="tiny">¬øQu√© necesito ahora?</label>
          <select id="needNow" class="select">
            <option value="">‚Äî Elegir ‚Äî</option>
            <option value="Descansar">Descansar</option>
            <option value="Comer/agua">Comer/agua</option>
            <option value="Moverme">Moverme</option>
            <option value="Poner l√≠mites">Poner l√≠mites</option>
            <option value="Hablar con alguien seguro">Hablar con alguien seguro</option>
            <option value="Silencio/pausa">Silencio/pausa</option>
            <option value="Organizarme">Organizarme</option>
            <option value="Ser amable conmigo">Ser amable conmigo</option>
          </select>
        </div>

        <div>
          <label class="tiny">Nota breve (opcional)</label>
          <input id="checkNote" class="input" type="text" placeholder="Ej. ‚ÄúMe sobrecargu√©‚Äù, ‚Äúme falt√≥ dormir‚Äù, ‚Äúme sent√≠ juzgada‚Äù‚Ä¶"/>
        </div>
      </div>

      <div class="row">
        <button class="btn ok" id="saveCheckBtn" type="button">Guardar chequeo</button>
        <button class="btn ghost" id="clearCheckBtn" type="button">Limpiar</button>
        <div class="pill">√öltimo: <span id="checkSavedAt">‚Äî</span></div>
      </div>

      <details>
        <summary>¬øPara qu√© sirve esto?</summary>
        <p class="tiny muted">
          En semanas vas a notar cosas como: ‚Äúcuando duermo poco sube mi intensidad‚Äù, o ‚Äúcuando pongo l√≠mites baja la ansiedad‚Äù.
          Es autoconocimiento, no juicio.
        </p>
      </details>
    </section>

    <!-- EVENT -->
    <section class="card">
      <h2>Registro importante</h2>
      <p class="muted">Registra una llamada, evento o algo que movi√≥ tu d√≠a.</p>

      <label class="tiny">¬øQu√© fue? (persona / evento)</label>
      <input id="evtWith" class="input" type="text" placeholder="Ej. reuni√≥n, escuela, familia, tr√°mite, etc." />

      <label class="tiny">Fecha y hora</label>
      <input id="evtAt" class="input" type="datetime-local" />

      <label class="tiny">Notas (opcional)</label>
      <textarea id="evtNotes" class="textarea" rows="4" placeholder="Ej. ‚ÄúMe satur√©‚Ä¶‚Äù, ‚ÄúMe dio claridad‚Ä¶‚Äù, etc."></textarea>

      <div class="row">
        <button class="btn" id="saveEvt" type="button">Guardar</button>
        <button class="btn ghost" id="clearEvt" type="button">Limpiar</button>
      </div>

      <div class="divider"></div>
      <p class="tiny muted">√öltimo registro</p>
      <div id="evtSummary" class="badge" style="width:100%; border-style:solid; border-color:rgba(255,255,255,0.12); background:rgba(255,255,255,0.04); padding:12px; border-radius:14px;">
        ‚Äî
      </div>
    </section>

    <!-- QUOTES -->
    <section class="card">
      <h2>Frase para ti</h2>
      <p class="muted">Elige lo que necesitas hoy. Si no te gusta la frase, c√°mbiala.</p>

      <label class="tiny">Hoy necesito‚Ä¶</label>
      <select id="needSelect" class="select">
        <option value="calma">Calma</option>
        <option value="fuerza">Fuerza</option>
        <option value="amorpropio">Amor propio</option>
        <option value="soltar">Soltar</option>
        <option value="ansiedad">Ansiedad</option>
        <option value="motivacion">Motivaci√≥n</option>
        <option value="apoyo">Apoyo</option>
      </select>

      <div class="divider"></div>
      <blockquote class="quote" id="quoteView">‚Äî</blockquote>
      <p class="tiny" id="quoteMeta">‚Äî</p>

      <div class="row">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="newQuoteBtn" type="button">Cambiar frase</button>
          <button class="btn ghost" id="saveQuoteBtn" type="button">Guardar frase</button>
          <button class="btn ghost" id="favQuoteBtn" type="button">‚≠ê Favorita</button>
        </div>
      </div>

      <div class="divider"></div>
      <div class="row" style="margin-top:0;">
        <p class="tiny muted" style="margin:0;">Favoritas</p>
        <button class="btn ghost" id="clearFavBtn" type="button">Limpiar favoritas</button>
      </div>
      <div class="list" id="favList"></div>
    </section>

    <!-- (3) CBT MINI -->
    <section class="card wide">
      <h2>Reestructuraci√≥n r√°pida (mini CBT)</h2>
      <p class="muted">Cuando un pensamiento te est√° dominando, aqu√≠ lo aterrizas con calma.</p>

      <div class="grid2">
        <div>
          <label class="tiny">Pensamiento autom√°tico</label>
          <textarea id="cbtAuto" class="textarea" rows="4" placeholder="Ej. ‚ÄúNo puedo con esto‚Äù, ‚ÄúVoy a fallar‚Äù, ‚ÄúNadie me entiende‚Äù‚Ä¶"></textarea>
        </div>
        <div>
          <label class="tiny">Emoci√≥n + intensidad</label>
          <input id="cbtEmotion" class="input" type="text" placeholder="Ej. ansiedad 7/10, tristeza 6/10, enojo 8/10" />
          <label class="tiny" style="margin-top:10px; display:block;">Qu√© estoy temiendo (opcional)</label>
          <input id="cbtFear" class="input" type="text" placeholder="Ej. ‚Äúque me rechacen‚Äù, ‚Äúquedar mal‚Äù, ‚Äúperder el control‚Äù‚Ä¶"/>
        </div>
      </div>

      <div class="divider"></div>

      <div class="grid2">
        <div>
          <label class="tiny">Evidencia a favor</label>
          <textarea id="cbtFor" class="textarea" rows="4" placeholder="Hechos, no suposiciones."></textarea>
        </div>
        <div>
          <label class="tiny">Evidencia en contra</label>
          <textarea id="cbtAgainst" class="textarea" rows="4" placeholder="Hechos que matizan o contradicen."></textarea>
        </div>
      </div>

      <div class="divider"></div>

      <label class="tiny">Pensamiento alternativo m√°s justo</label>
      <textarea id="cbtAlt" class="textarea" rows="4" placeholder="Ej. ‚ÄúEstoy pasando un momento dif√≠cil, pero puedo con un paso peque√±o.‚Äù"></textarea>

      <div class="row">
        <button class="btn ok" id="saveCbtBtn" type="button">Guardar CBT</button>
        <button class="btn ghost" id="clearCbtBtn" type="button">Limpiar</button>
        <div class="pill">√öltimo: <span id="cbtSavedAt">‚Äî</span></div>
      </div>

      <details>
        <summary>Tips r√°pidos</summary>
        <p class="tiny muted">
          1) ‚ÄúHechos‚Äù > ‚Äúhistorias‚Äù. 2) Un pensamiento alternativo no tiene que ser positivo, solo justo. 3) Si est√°s muy activada, usa ‚ÄúEstoy muy mal‚Äù primero.
        </p>
      </details>
    </section>

    <!-- HISTORY -->
    <section class="card wide">
      <h2>Historial por d√≠a</h2>
      <p class="muted">Se guarda autom√°ticamente cuando registras algo. Tambi√©n puedes guardarlo manualmente.</p>

      <div class="row" style="align-items:flex-end;">
        <div style="flex:1; min-width:220px;">
          <label class="tiny">Fecha de la entrada</label>
          <input id="entryDate" class="input" type="date" />
          <p class="tiny muted" style="margin:6px 0 0;">Por defecto es hoy.</p>
        </div>

        <div style="flex:1; min-width:220px;">
          <label class="tiny">Buscar en historial</label>
          <input id="searchInput" class="input" type="text" placeholder="Ej. ansiedad, escuela, enojo, calma..." />
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn ok" id="saveDayBtn" type="button">Guardar d√≠a</button>
          <button class="btn ghost" id="openDayBtn" type="button">Abrir ese d√≠a</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row" style="margin-top:0;">
        <div class="pill">üìå Entradas: <span id="entryCount">0</span></div>
        <div class="pill">üóìÔ∏è √öltimos primero</div>
      </div>

      <div class="list" id="historyList"></div>
    </section>

    <!-- STATS -->
    <section class="card wide">
      <h2>Estad√≠sticas suaves (√∫ltimos 30 d√≠as)</h2>
      <p class="muted">Un espejo, no una calificaci√≥n.</p>
      <div class="grid2" id="statsGrid"></div>
      <details>
        <summary>Extra (nuevo)</summary>
        <p class="tiny muted">
          M√°s adelante podemos graficar intensidad promedio por semana. (Si la quieres, la agrego).
        </p>
      </details>
    </section>

    <!-- SETTINGS + BACKUP -->
    <section class="card wide">
      <h2>Ajustes y Respaldo</h2>
      <p class="muted">Privado y local. PIN opcional. Respaldo JSON/TXT.</p>

      <div class="divider"></div>

      <h3>üßØ Kit de emergencia</h3>
      <p class="tiny muted" style="margin-top:0;">
        Esto alimenta el bot√≥n ‚ÄúEstoy muy mal‚Äù. Puedes cambiarlo cuando quieras.
      </p>

      <div class="grid2">
        <div>
          <label class="tiny">Mis anclas (cosas que me calman)</label>
          <textarea id="anchors" class="textarea" rows="5" placeholder="Ej. m√∫sica, t√©, ba√±o, caminar, oraci√≥n, escribir, abrazar almohada‚Ä¶ (una por l√≠nea)"></textarea>
        </div>
        <div>
          <label class="tiny">Personas seguras (solo nombres)</label>
          <textarea id="safePeople" class="textarea" rows="5" placeholder="Ej. Mam√°\nAmiga X\nCompa√±era Y (una por l√≠nea)"></textarea>
          <p class="tiny muted" style="margin-top:8px;">
            Nota: No enviamos mensajes solos. Solo te damos un texto para copiar.
          </p>
        </div>
      </div>

      <div class="row">
        <button class="btn ok" id="saveKitBtn" type="button">Guardar kit</button>
        <button class="btn ghost" id="clearKitBtn" type="button">Limpiar</button>
        <div class="pill">√öltimo: <span id="kitSavedAt">‚Äî</span></div>
      </div>

      <div class="divider"></div>

      <h3>üîê PIN (opcional)</h3>
      <p class="tiny muted" style="margin-top:0;">Bloqueo simple (no cifrado avanzado). Para privacidad b√°sica.</p>

      <div class="row">
        <div style="flex:1; min-width:220px;">
          <label class="tiny">Nuevo PIN (solo n√∫meros)</label>
          <input id="pinSet" class="input" type="password" inputmode="numeric" placeholder="Ej. 1234" />
        </div>
        <div style="flex:1; min-width:220px;">
          <label class="tiny">Confirmar PIN</label>
          <input id="pinSet2" class="input" type="password" inputmode="numeric" placeholder="Repite el PIN" />
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="setPinBtn" type="button">Guardar PIN</button>
          <button class="btn ghost" id="togglePinBtn" type="button">Activar/Desactivar PIN</button>
          <button class="btn danger" id="removePinBtn" type="button">Quitar PIN</button>
        </div>
      </div>

      <p class="tiny" id="pinStatus">‚Äî</p>

      <div class="divider"></div>

      <h3>üíæ Respaldo</h3>
      <div class="row">
        <button class="btn" id="exportJsonBtn" type="button">Exportar JSON</button>
        <button class="btn ghost" id="exportTxtBtn" type="button">Exportar TXT (legible)</button>
        <label class="btn ghost" for="importFile" role="button">Importar</label>
        <input id="importFile" type="file" accept="application/json" hidden />
        <button class="btn danger" id="wipeBtn" type="button">Borrar todo</button>
      </div>

      <details>
        <summary>¬øQu√© es un JSON?</summary>
        <p class="tiny muted">
          Un JSON es un archivo de texto que guarda datos ‚Äúen orden‚Äù. Exportar = descargar tu respaldo. Importar = recuperarlo.
        </p>
      </details>

      <details>
        <summary>Ver datos (solo lectura)</summary>
        <pre id="dataPreview">{}</pre>
      </details>
    </section>
  </main>

  <footer class="wrap" id="footer" style="display:none;">
    <p class="tiny muted">Hecho por Claudia Alejandra Garza Hernandez ‚ú® ‚Äî privado, offline, sin cuentas.</p>

  </footer>

  <!-- PAUSE MODAL -->
  <div class="overlay" id="pauseOverlay" aria-hidden="true">
    <div class="modal">
      <h3>üßò Pausa de 30 segundos</h3>
      <p class="muted" id="pauseText" style="margin-top:0;">‚Äî</p>
      <div class="badge" id="pauseTimer" style="width:max-content;">30s</div>
      <div class="modalActions">
        <button class="btn ghost" id="pauseSwitchBtn" type="button">Cambiar ejercicio</button>
        <button class="btn" id="pauseStartBtn" type="button">Iniciar</button>
        <button class="btn danger" id="pauseCloseBtn" type="button">Cerrar</button>
      </div>
      <details>
        <summary>Por qu√© ayuda</summary>
        <p class="tiny muted">Primero regulas el cuerpo, luego piensas con m√°s claridad.</p>
      </details>
    </div>
  </div>

  <!-- (5) EMERGENCY MODAL -->
  <div class="overlay" id="emergencyOverlay" aria-hidden="true">
    <div class="modal">
      <h3>üßØ Kit de emergencia</h3>
      <p class="muted" style="margin-top:0;">
        No tienes que resolverlo todo ahorita. Solo baja la intensidad y elige un paso peque√±o.
      </p>

      <div class="tabs">
        <button class="tab active" data-tab="calm" type="button">Bajar intensidad</button>
        <button class="tab" data-tab="ground" type="button">Aterrizar</button>
        <button class="tab" data-tab="anchors" type="button">Mis anclas</button>
        <button class="tab" data-tab="support" type="button">Pedir apoyo</button>
      </div>

      <div id="emTabCalm" style="margin-top:12px;">
        <div class="quote">
          <strong>Primero:</strong> 3 respiraciones lentas. <br>
          <span class="tiny muted">Inhala 4 ¬∑ sost√©n 2 ¬∑ exhala 6 (suave)</span>
        </div>
        <div class="row">
          <button class="btn warn" id="emStart30" type="button">Usar Pausa 30s</button>
          <button class="btn ghost" id="emMicroPlan" type="button">Dame un paso peque√±o</button>
        </div>
        <div class="badge" id="emPlanOut" style="border-style:solid; width:100%;">‚Äî</div>
      </div>

      <div id="emTabGround" style="margin-top:12px; display:none;">
        <div class="quote">
          <strong>5‚Äì4‚Äì3‚Äì2‚Äì1</strong><br>
          5 cosas que ves ¬∑ 4 que sientes ¬∑ 3 que escuchas ¬∑ 2 que hueles ¬∑ 1 que agradeces.
        </div>
        <div class="row">
          <button class="btn" id="emCopyGround" type="button">Copiar gu√≠a</button>
          <button class="btn ghost" id="emGroundNext" type="button">Otra gu√≠a</button>
        </div>
        <div class="badge" id="emGroundOut" style="border-style:solid; width:100%;">‚Äî</div>
      </div>

      <div id="emTabAnchors" style="margin-top:12px; display:none;">
        <div class="quote">
          <strong>Elige 1 ancla</strong><br>
          <span class="tiny muted">No tienes que hacer 5 cosas. Solo una.</span>
        </div>
        <div class="list" id="emAnchorsList"></div>
      </div>

      <div id="emTabSupport" style="margin-top:12px; display:none;">
        <div class="quote">
          <strong>Pedir apoyo</strong><br>
          <span class="tiny muted">Copia un mensaje corto (no se env√≠a solo).</span>
        </div>

        <label class="tiny">Elige a qui√©n</label>
        <select id="emPerson" class="select">
          <option value="">‚Äî Elegir ‚Äî</option>
        </select>

        <label class="tiny" style="margin-top:10px; display:block;">Mensaje sugerido</label>
        <textarea id="emMessage" class="textarea" rows="4"></textarea>

        <div class="row">
          <button class="btn" id="emCopyMsg" type="button">Copiar mensaje</button>
          <button class="btn ghost" id="emMsgRefresh" type="button">Cambiar texto</button>
        </div>

        <details>
          <summary>Si est√°s en riesgo inmediato</summary>
          <p class="tiny muted">
            Si sientes que podr√≠as hacerte da√±o o est√°s en peligro, busca ayuda urgente con alguien cercano o servicios de emergencia de tu zona.
          </p>
        </details>
      </div>

      <!-- ABOUT MODAL -->
<div class="overlay" id="aboutOverlay" aria-hidden="true">
  <div class="modal">
    <h3>‚ÑπÔ∏è Acerca de</h3>

    <p class="muted" style="margin-top:0;">
      <strong>Mi App Personal</strong> es una herramienta de regulaci√≥n emocional:
      registrar, respirar, entender y avanzar.
    </p>

    <div class="divider"></div>

    <p class="muted" style="margin:0;">
      <strong>Autor√≠a:</strong> Claudia Alejandra Garza Hernandez<br>
      <strong>¬©</strong> <span id="aboutYear"></span> ¬∑ Todos los derechos reservados.
    </p>

    <p class="tiny muted" style="margin-top:10px;">
      Esta app funciona offline y guarda la informaci√≥n solo en tu dispositivo.
      No usa cuentas ni servidores.
    </p>

    <details>
      <summary>Licencia</summary>
      <p class="tiny muted">
        Prohibida la copia, modificaci√≥n o distribuci√≥n sin permiso por escrito
        de la autora.
      </p>
    </details>

    <div class="modalActions">
      <button class="btn ghost" id="aboutCopyBtn" type="button">Copiar autor√≠a</button>
      <button class="btn danger" id="aboutCloseBtn" type="button">Cerrar</button>
    </div>
  </div>
</div>

      <div class="modalActions">
        <button class="btn danger" id="emCloseBtn" type="button">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    // ========= KEYS =========
    const APP_KEY = "mi_app_personal_v4"; // mantenemos para NO perder tus datos
    const PIN_KEY = "mi_app_personal_pin_v1";
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => document.querySelectorAll(s);

    // ========= QUOTES =========
    const QUOTES = {
      calma: [
        {t:"Respira. Aqu√≠ y ahora es suficiente.", a:"An√≥nima"},
        {t:"La calma tambi√©n se entrena.", a:"An√≥nima"},
        {t:"No corras: vuelve a tu cuerpo.", a:"An√≥nima"},
        {t:"Un minuto de paz cambia el d√≠a.", a:"An√≥nima"},
        {t:"Lo simple: inhalar, exhalar, seguir.", a:"An√≥nima"},
        {t:"No tienes prisa para sanar.", a:"An√≥nima"},
      ],
      fuerza: [
        {t:"No se trata de aguantar; se trata de sostenerte.", a:"An√≥nima"},
        {t:"Tu fuerza es real, incluso cuando dudas.", a:"An√≥nima"},
        {t:"Hazlo con miedo, pero hazlo.", a:"An√≥nima"},
        {t:"Un paso peque√±o tambi√©n es avance.", a:"An√≥nima"},
        {t:"La valent√≠a puede ser silenciosa.", a:"An√≥nima"},
      ],
      amorpropio: [
        {t:"S√© amable contigo: est√°s aprendiendo.", a:"An√≥nima"},
        {t:"Tu valor no depende de tu d√≠a.", a:"An√≥nima"},
        {t:"Tr√°tate como tratar√≠as a quien amas.", a:"An√≥nima"},
        {t:"No te abandones.", a:"An√≥nima"},
        {t:"Cuidarte no es ego√≠smo; es necesidad.", a:"An√≥nima"},
      ],
      soltar: [
        {t:"Soltar no es olvidar: es dejar de cargar.", a:"An√≥nima"},
        {t:"No todo lo que duele es para quedarse.", a:"An√≥nima"},
        {t:"Suelta lo que no puedes controlar.", a:"An√≥nima"},
        {t:"Tu paz vale m√°s que la costumbre.", a:"An√≥nima"},
        {t:"Cerrar ciclos tambi√©n es amor.", a:"An√≥nima"},
      ],
      ansiedad: [
        {t:"No todo pensamiento es una verdad.", a:"An√≥nima"},
        {t:"Esto es una ola: pasa.", a:"An√≥nima"},
        {t:"Regresa a la respiraci√≥n: es tu ancla.", a:"An√≥nima"},
        {t:"Tu mente grita, pero t√∫ decides el ritmo.", a:"An√≥nima"},
        {t:"La ansiedad miente con urgencia.", a:"An√≥nima"},
      ],
      motivacion: [
        {t:"El secreto de avanzar es comenzar.", a:"An√≥nima"},
        {t:"Lo importante: volver a intentarlo.", a:"An√≥nima"},
        {t:"Hoy cuenta, aunque sea lento.", a:"An√≥nima"},
        {t:"Haz lo que puedas con lo que tienes.", a:"An√≥nima"},
        {t:"Eres capaz de m√°s de lo que crees.", a:"An√≥nima"},
      ],
      apoyo: [
        {t:"No tienes que poder con todo sola.", a:"An√≥nima"},
        {t:"Pedir ayuda tambi√©n es valent√≠a.", a:"An√≥nima"},
        {t:"Lo que sientes es v√°lido.", a:"An√≥nima"},
        {t:"Estoy contigo: un paso a la vez.", a:"An√≥nima"},
        {t:"Mereces cuidado y descanso.", a:"An√≥nima"},
      ]
    };

    // ========= STATE =========
    const state = {
      version: 5, // subimos versi√≥n interna
      mood: null,
      thought: "",
      thoughtSavedAt: null,
      event: { with:"", at:"", notes:"", savedAt:null },
      need: "calma",
      quoteCurrent: null,
      favorites: [],
      history: {},
      lastOpenedDate: null,

      // (1) Chequeo r√°pido
      check: {
        intensity: 0,
        trigger: "",
        triggerOther: "",
        needNow: "",
        note: "",
        savedAt: null
      },

      // (3) CBT mini
      cbt: {
        auto: "",
        emotion: "",
        fear: "",
        for: "",
        against: "",
        alt: "",
        savedAt: null
      },

      // (5) Kit de emergencia
      kit: {
        anchors: [],
        safePeople: [],
        savedAt: null
      }
    };

    // ========= UTILS =========
    function nowISO(){ return new Date().toISOString(); }
    function safeParse(j,f){ try{return JSON.parse(j);}catch{return f;} }
    function toDateKey(d=new Date()){
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,"0");
      const day=String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function formatDate(iso){
      if(!iso) return "‚Äî";
      const d = new Date(iso);
      if(Number.isNaN(d.getTime())) return "‚Äî";
      return d.toLocaleString("es-MX",{dateStyle:"medium",timeStyle:"short"});
    }
    function setStatus(t){
      const el=$("#statusText");
      if(el) el.textContent=t;
      clearTimeout(window.__st);
      window.__st=setTimeout(()=>{ if(el) el.textContent="Listo"; },1200);
    }
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function labelNeed(need){
      const map = {
        calma:"Calma", fuerza:"Fuerza", amorpropio:"Amor propio",
        soltar:"Soltar", ansiedad:"Ansiedad", motivacion:"Motivaci√≥n", apoyo:"Apoyo"
      };
      return map[need] || "Calma";
    }

    // ========= SAVE / LOAD =========
    function save(){
      localStorage.setItem(APP_KEY, JSON.stringify(state, null, 2));
      renderPreview();
    }

    function load(){
      const raw = localStorage.getItem(APP_KEY);
      if(!raw) return;
      const loaded = safeParse(raw,null);
      if(!loaded || typeof loaded!=="object") return;

      // compat
      state.version = loaded.version ?? state.version;
      state.mood = loaded.mood ?? state.mood;
      state.thought = loaded.thought ?? state.thought;
      state.thoughtSavedAt = loaded.thoughtSavedAt ?? state.thoughtSavedAt;

      if(loaded.event && typeof loaded.event==="object"){
        state.event.with = loaded.event.with ?? state.event.with;
        state.event.at = loaded.event.at ?? state.event.at;
        state.event.notes = loaded.event.notes ?? state.event.notes;
        state.event.savedAt = loaded.event.savedAt ?? state.event.savedAt;
      }

      state.need = loaded.need ?? state.need;
      state.quoteCurrent = loaded.quoteCurrent ?? state.quoteCurrent;
      state.favorites = Array.isArray(loaded.favorites) ? loaded.favorites : state.favorites;
      state.history = (loaded.history && typeof loaded.history==="object") ? loaded.history : state.history;
      state.lastOpenedDate = loaded.lastOpenedDate ?? state.lastOpenedDate;

      // nuevos campos (si existen)
      if(loaded.check && typeof loaded.check==="object"){
        state.check = {
          intensity: Number(loaded.check.intensity ?? state.check.intensity) || 0,
          trigger: loaded.check.trigger ?? "",
          triggerOther: loaded.check.triggerOther ?? "",
          needNow: loaded.check.needNow ?? "",
          note: loaded.check.note ?? "",
          savedAt: loaded.check.savedAt ?? null
        };
      }

      if(loaded.cbt && typeof loaded.cbt==="object"){
        state.cbt = {
          auto: loaded.cbt.auto ?? "",
          emotion: loaded.cbt.emotion ?? "",
          fear: loaded.cbt.fear ?? "",
          for: loaded.cbt.for ?? "",
          against: loaded.cbt.against ?? "",
          alt: loaded.cbt.alt ?? "",
          savedAt: loaded.cbt.savedAt ?? null
        };
      }

      if(loaded.kit && typeof loaded.kit==="object"){
        state.kit = {
          anchors: Array.isArray(loaded.kit.anchors) ? loaded.kit.anchors : [],
          safePeople: Array.isArray(loaded.kit.safePeople) ? loaded.kit.safePeople : [],
          savedAt: loaded.kit.savedAt ?? null
        };
      }
    }

    // ========= QUOTES =========
    function getPool(need){ return QUOTES[need] || QUOTES.calma; }
    function pickRandomQuote(need, excludeText=null){
      const pool = getPool(need);
      if(pool.length===0) return null;
      if(pool.length===1) return {...pool[0], i:0, need};
      let tries=0, q=null;
      while(tries<12){
        const i=Math.floor(Math.random()*pool.length);
        q={...pool[i], i, need};
        if(!excludeText || q.t!==excludeText) break;
        tries++;
      }
      return q;
    }
    function ensureCurrentQuote(){
      const need = state.need || "calma";
      if(!state.quoteCurrent || typeof state.quoteCurrent!=="object" || state.quoteCurrent.need !== need){
        state.quoteCurrent = pickRandomQuote(need, null);
      }
    }

    // ========= DAILY ENTRY =========
    function getEntryDate(){ return $("#entryDate").value || toDateKey(new Date()); }

    function buildEntry(dateKey){
      return {
        date: dateKey,
        savedAt: nowISO(),
        mood: state.mood,
        thought: state.thought,
        thoughtSavedAt: state.thoughtSavedAt,
        event: {...state.event},
        need: state.need,
        quoteCurrent: state.quoteCurrent ? {...state.quoteCurrent} : null,

        // nuevos
        check: {...state.check},
        cbt: {...state.cbt}
      };
    }

    function autoSaveDay(){
      const key = getEntryDate();
      state.history[key] = buildEntry(key);
      state.lastOpenedDate = key;
      save();
      renderHistory();
      renderStats();
      setStatus("Guardado (auto)");
    }

    function saveDayManual(){
      const key = getEntryDate();
      state.history[key] = buildEntry(key);
      state.lastOpenedDate = key;
      save();
      renderHistory();
      renderStats();
      setStatus("D√≠a guardado");
    }

    function openDay(dateKey){
      const e = state.history[dateKey];
      if(!e){ alert("No existe esa entrada."); return; }

      state.mood = e.mood ?? null;
      state.thought = e.thought ?? "";
      state.thoughtSavedAt = e.thoughtSavedAt ?? null;

      if(e.event && typeof e.event==="object"){
        state.event.with = e.event.with ?? "";
        state.event.at = e.event.at ?? "";
        state.event.notes = e.event.notes ?? "";
        state.event.savedAt = e.event.savedAt ?? null;
      }else{
        state.event = { with:"", at:"", notes:"", savedAt:null };
      }

      state.need = e.need ?? "calma";
      state.quoteCurrent = e.quoteCurrent ?? null;

      if(e.check && typeof e.check==="object"){
        state.check = {
          intensity: Number(e.check.intensity ?? 0) || 0,
          trigger: e.check.trigger ?? "",
          triggerOther: e.check.triggerOther ?? "",
          needNow: e.check.needNow ?? "",
          note: e.check.note ?? "",
          savedAt: e.check.savedAt ?? null
        };
      }

      if(e.cbt && typeof e.cbt==="object"){
        state.cbt = {
          auto: e.cbt.auto ?? "",
          emotion: e.cbt.emotion ?? "",
          fear: e.cbt.fear ?? "",
          for: e.cbt.for ?? "",
          against: e.cbt.against ?? "",
          alt: e.cbt.alt ?? "",
          savedAt: e.cbt.savedAt ?? null
        };
      }

      state.lastOpenedDate = dateKey;
      $("#entryDate").value = dateKey;

      save();
      renderAll();
      setStatus("D√≠a abierto");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // ========= RENDER =========
    function renderMood(){
      $("#moodBadge").textContent = state.mood ? `Hoy: ${state.mood}` : "Hoy: ‚Äî";
      $$(".chip").forEach(btn=>{
        const m = btn.getAttribute("data-mood");
        btn.classList.toggle("active", m===state.mood);
      });
    }

    function renderThought(){
      $("#thought").value = state.thought || "";
      $("#thoughtSavedAt").textContent = state.thoughtSavedAt
        ? `Guardado: ${formatDate(state.thoughtSavedAt)}`
        : "‚Äî";
    }

    function renderEvent(){
      $("#evtWith").value = state.event.with || "";
      $("#evtAt").value = state.event.at || "";
      $("#evtNotes").value = state.event.notes || "";

      const sum=$("#evtSummary");
      const who = (state.event.with||"").trim() || "‚Äî";
      const when = state.event.at ? new Date(state.event.at) : null;
      const whenText = (when && !Number.isNaN(when.getTime()))
        ? when.toLocaleString("es-MX",{dateStyle:"medium",timeStyle:"short"})
        : "‚Äî";
      const notes = (state.event.notes||"").trim() || "‚Äî";
      const saved = state.event.savedAt ? formatDate(state.event.savedAt) : "‚Äî";

      sum.innerHTML = `
        <div><strong>¬øQu√© fue?:</strong> ${escapeHtml(who)}</div>
        <div><strong>Fecha/hora:</strong> ${escapeHtml(whenText)}</div>
        <div><strong>Notas:</strong> ${escapeHtml(notes)}</div>
        <div class="tiny muted" style="margin-top:8px;">Guardado: ${escapeHtml(saved)}</div>
      `;
    }

    function renderQuote(){
      $("#needSelect").value = state.need || "calma";
      ensureCurrentQuote();
      const q = state.quoteCurrent;
      $("#quoteView").textContent = q ? `‚Äú${q.t}‚Äù` : "‚Äî";
      $("#quoteMeta").textContent = q ? `‚Äî ${q.a} ¬∑ Tema: ${labelNeed(q.need)}` : "‚Äî";
    }

    function renderFavorites(){
      const box = $("#favList");
      box.innerHTML = "";
      if(!state.favorites.length){
        box.innerHTML = `<div class="badge" style="width:100%; border-style:solid;">No tienes favoritas a√∫n. Usa ‚≠ê para guardar.</div>`;
        return;
      }

      state.favorites
        .slice()
        .sort((a,b)=> (b.addedAt||"").localeCompare(a.addedAt||""))
        .forEach((f, idx)=>{
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <div class="itemTop">
              <div class="pill">‚≠ê ${escapeHtml(labelNeed(f.need||"calma"))}</div>
              <div class="tiny muted">${escapeHtml(formatDate(f.addedAt))}</div>
            </div>
            <div style="margin-top:8px;">‚Äú${escapeHtml(f.t)}‚Äù</div>
            <div class="tiny muted" style="margin-top:6px;">‚Äî ${escapeHtml(f.a||"An√≥nima")}</div>
            <div class="row" style="justify-content:flex-end;">
              <button class="btn ghost" data-act="use" data-idx="${idx}" type="button">Usar</button>
              <button class="btn danger" data-act="del" data-idx="${idx}" type="button">Eliminar</button>
            </div>
          `;
          box.appendChild(div);
        });

      box.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const act = btn.getAttribute("data-act");
          const idx = Number(btn.getAttribute("data-idx"));
          const sorted = state.favorites.slice().sort((a,b)=> (b.addedAt||"").localeCompare(a.addedAt||""));
          const fav = sorted[idx];
          if(!fav) return;

          if(act==="use"){
            state.need = fav.need || "calma";
            state.quoteCurrent = { t:fav.t, a:fav.a||"An√≥nima", i:null, need: state.need };
            save();
            renderQuote();
            setStatus("Frase aplicada");
            autoSaveDay();
          }
          if(act==="del"){
            state.favorites = state.favorites.filter(x => !(x.t===fav.t && x.addedAt===fav.addedAt));
            save();
            renderFavorites();
            setStatus("Eliminada");
          }
        });
      });
    }

    function renderHistory(){
      const list = $("#historyList");
      list.innerHTML = "";

      const keys = Object.keys(state.history || {}).sort((a,b)=> b.localeCompare(a));
      $("#entryCount").textContent = String(keys.length);

      const q = ($("#searchInput").value || "").trim().toLowerCase();
      const filtered = keys.filter(k=>{
        if(!q) return true;
        const e = state.history[k];
        const hay = [
          k,
          e?.mood||"",
          e?.thought||"",
          e?.event?.with||"",
          e?.event?.notes||"",
          e?.quoteCurrent?.t||"",
          e?.check?.trigger||"",
          e?.check?.needNow||"",
          e?.cbt?.auto||"",
          e?.cbt?.alt||""
        ].join(" ").toLowerCase();
        return hay.includes(q);
      });

      if(!filtered.length){
        list.innerHTML = `<div class="badge" style="width:100%; border-style:solid;">No hay resultados.</div>`;
        return;
      }

      filtered.forEach(dateKey=>{
        const e = state.history[dateKey];
        const mood = e?.mood || "‚Äî";
        const intensity = (e?.check?.intensity ?? null);
        const intenTxt = (intensity === null || intensity === undefined) ? "" : ` ¬∑ Int: ${intensity}/10`;
        const thought = (e?.thought||"").trim();
        const snippet = thought ? thought.slice(0, 110) + (thought.length>110 ? "‚Ä¶" : "") : "Sin pensamiento guardado.";
        const when = e?.savedAt ? formatDate(e.savedAt) : "‚Äî";

        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="itemTop">
            <div><strong>${escapeHtml(dateKey)}</strong></div>
            <div class="pill">Estado: ${escapeHtml(mood)}${escapeHtml(intenTxt)}</div>
          </div>
          <div class="tiny muted" style="margin-top:6px;">Guardado: ${escapeHtml(when)}</div>
          <div style="margin-top:10px;">${escapeHtml(snippet)}</div>
          <div class="row" style="justify-content:flex-end;">
            <button class="btn ghost" data-open="${escapeHtml(dateKey)}" type="button">Abrir</button>
            <button class="btn danger" data-del="${escapeHtml(dateKey)}" type="button">Eliminar</button>
          </div>
        `;
        list.appendChild(div);
      });

      list.querySelectorAll("button[data-open]").forEach(btn=>{
        btn.addEventListener("click", ()=> openDay(btn.getAttribute("data-open")));
      });

      list.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const key = btn.getAttribute("data-del");
          if(!confirm(`¬øEliminar la entrada del ${key}?`)) return;
          delete state.history[key];
          save();
          renderHistory();
          renderStats();
          setStatus("Eliminada");
        });
      });
    }

    function renderStats(){
      const grid = $("#statsGrid");
      grid.innerHTML = "";

      const keys = Object.keys(state.history || {}).sort((a,b)=> b.localeCompare(a));
      const last30 = keys.slice(0, 30).map(k=> state.history[k]);
      const total = last30.length;

      if(!total){
        grid.innerHTML = `<div class="badge" style="width:100%; border-style:solid;">A√∫n no hay entradas diarias. Se guardan en autom√°tico cuando registras algo.</div>`;
        return;
      }

      const moods = {};
      let sumIntensity = 0;
      let countIntensity = 0;

      last30.forEach(e=>{
        const m = e?.mood || "Sin registro";
        moods[m] = (moods[m]||0) + 1;
        const inten = e?.check?.intensity;
        if(typeof inten === "number" && !Number.isNaN(inten)){
          sumIntensity += inten;
          countIntensity++;
        }
      });

      const topMood = Object.entries(moods).sort((a,b)=> b[1]-a[1])[0] || ["‚Äî",0];
      const anxious = moods["Ansiosa"] || 0;
      const calm = moods["Tranquila"] || 0;
      const annoyed = moods["Molesta"] || 0;
      const avgInt = countIntensity ? (sumIntensity / countIntensity).toFixed(1) : "‚Äî";

      const stats = [
        {big: total, small:"D√≠as guardados (√∫ltimos 30)"},
        {big: topMood[0], small:`M√°s frecuente (${topMood[1]} d√≠as)`},
        {big: calm, small:"D√≠as Tranquila"},
        {big: anxious, small:"D√≠as Ansiosa"},
        {big: annoyed, small:"D√≠as Molesta"},
        {big: avgInt, small:"Intensidad promedio (0‚Äì10)"},
      ];

      stats.forEach(s=>{
        const div = document.createElement("div");
        div.className = "stat";
        div.innerHTML = `<strong>${escapeHtml(String(s.big))}</strong><span>${escapeHtml(s.small)}</span>`;
        grid.appendChild(div);
      });
    }

    function renderCheck(){
      $("#intensity").value = String(state.check.intensity ?? 0);
      $("#intensityVal").textContent = String(state.check.intensity ?? 0);
      $("#trigger").value = state.check.trigger ?? "";
      $("#triggerOther").value = state.check.triggerOther ?? "";
      $("#needNow").value = state.check.needNow ?? "";
      $("#checkNote").value = state.check.note ?? "";
      $("#checkSavedAt").textContent = state.check.savedAt ? formatDate(state.check.savedAt) : "‚Äî";

      const showOther = ($("#trigger").value === "Otro");
      $("#triggerOtherWrap").style.display = showOther ? "block" : "none";
    }

    function renderCbt(){
      $("#cbtAuto").value = state.cbt.auto ?? "";
      $("#cbtEmotion").value = state.cbt.emotion ?? "";
      $("#cbtFear").value = state.cbt.fear ?? "";
      $("#cbtFor").value = state.cbt.for ?? "";
      $("#cbtAgainst").value = state.cbt.against ?? "";
      $("#cbtAlt").value = state.cbt.alt ?? "";
      $("#cbtSavedAt").textContent = state.cbt.savedAt ? formatDate(state.cbt.savedAt) : "‚Äî";
    }

    function renderKit(){
      $("#anchors").value = (state.kit.anchors || []).join("\n");
      $("#safePeople").value = (state.kit.safePeople || []).join("\n");
      $("#kitSavedAt").textContent = state.kit.savedAt ? formatDate(state.kit.savedAt) : "‚Äî";
      refreshEmergencyLists();
    }

    function renderPreview(){
      $("#dataPreview").textContent = JSON.stringify(state, null, 2);
    }

    function renderAll(){
      renderMood();
      renderThought();
      renderEvent();
      renderQuote();
      renderFavorites();
      renderCheck();
      renderCbt();
      renderKit();
      renderHistory();
      renderStats();
      renderPinStatus();
      renderPreview();
    }

    // ========= PAUSE =========
    const PAUSE_EX = [
      { title:"Respiraci√≥n 4‚Äì4‚Äì6", steps:["Inhala 4s.","Sost√©n 4s.","Exhala 6s.","Repite suave."] },
      { title:"Grounding 5‚Äì4‚Äì3‚Äì2‚Äì1", steps:["5 cosas que ves.","4 cosas que sientes.","3 que escuchas.","2 que hueles.","1 que agradeces."] },
      { title:"Mano al pecho", steps:["Mano al pecho.","Di: ‚ÄúEstoy a salvo ahora‚Äù.","Respira 3 veces.","Elige un paso peque√±o."] }
    ];
    let pauseIdx=0, pauseT=30, pauseTimer=null;

    function updatePauseText(){
      const ex = PAUSE_EX[pauseIdx % PAUSE_EX.length];
      $("#pauseText").innerHTML = `<strong>${escapeHtml(ex.title)}</strong><br><br>${ex.steps.map(s=>`‚Ä¢ ${escapeHtml(s)}`).join("<br>")}`;
    }
    function openPause(){
      $("#pauseOverlay").style.display = "flex";
      $("#pauseOverlay").setAttribute("aria-hidden","false");
      pauseT=30; updatePauseText();
      $("#pauseTimer").textContent="30s";
    }
    function stopPause(){
      if(pauseTimer){ clearInterval(pauseTimer); pauseTimer=null; }
    }
    function startPause(){
      stopPause();
      pauseT=30;
      $("#pauseTimer").textContent="30s";
      pauseTimer=setInterval(()=>{
        pauseT--;
        $("#pauseTimer").textContent = `${pauseT}s`;
        if(pauseT<=0){
          stopPause();
          $("#pauseTimer").textContent="Listo";
          setStatus("Pausa completa");
        }
      },1000);
    }
    function closePause(){
      $("#pauseOverlay").style.display="none";
      $("#pauseOverlay").setAttribute("aria-hidden","true");
      stopPause();
    }

    // ========= (5) EMERGENCY =========
    const MICRO_PLANS = [
      "Toma agua y respira 3 veces lento.",
      "Mu√©vete 2 minutos: estira cuello/hombros.",
      "Escribe 3 l√≠neas: ‚ÄúQu√© siento / qu√© necesito / un paso peque√±o‚Äù.",
      "Lava tu cara con agua fr√≠a y exhala largo.",
      "Haz una cosa m√≠nima: ordenar 1 espacio peque√±o.",
      "Pon un l√≠mite micro: ‚Äúahorita no puedo, te respondo despu√©s‚Äù."
    ];
    const GROUND_GUIDES = [
      "5‚Äì4‚Äì3‚Äì2‚Äì1: 5 ves ¬∑ 4 sientes ¬∑ 3 escuchas ¬∑ 2 hueles ¬∑ 1 agradeces.",
      "Nombra 3 colores alrededor + 3 texturas + 3 sonidos.",
      "Presiona tus pies en el piso 10s y suelta; repite 3 veces.",
      "Mira un punto fijo 10s: describe forma, color, sombra, borde."
    ];
    let groundIdx = 0;

    function openEmergency(){
      $("#emergencyOverlay").style.display="flex";
      $("#emergencyOverlay").setAttribute("aria-hidden","false");
      setEmergencyTab("calm");
      $("#emPlanOut").textContent = "‚Äî";
      $("#emGroundOut").textContent = GROUND_GUIDES[groundIdx % GROUND_GUIDES.length];
      buildSupportMessage();
    }
    function closeEmergency(){
      $("#emergencyOverlay").style.display="none";
      $("#emergencyOverlay").setAttribute("aria-hidden","true");
    }

    function setEmergencyTab(tab){
      $$(".tab").forEach(b=> b.classList.toggle("active", b.getAttribute("data-tab")===tab));
      $("#emTabCalm").style.display = (tab==="calm") ? "block" : "none";
      $("#emTabGround").style.display = (tab==="ground") ? "block" : "none";
      $("#emTabAnchors").style.display = (tab==="anchors") ? "block" : "none";
      $("#emTabSupport").style.display = (tab==="support") ? "block" : "none";
    }

    function refreshEmergencyLists(){
      // Anchors list
      const list = $("#emAnchorsList");
      list.innerHTML = "";
      const anchors = (state.kit.anchors || []).filter(x=> String(x||"").trim());
      if(!anchors.length){
        list.innerHTML = `<div class="badge" style="width:100%; border-style:solid;">A√∫n no escribes anclas. Ve a Ajustes ‚Üí Kit de emergencia.</div>`;
      } else {
        anchors.forEach(a=>{
          const div = document.createElement("div");
          div.className="item";
          div.innerHTML = `
            <div><strong>${escapeHtml(a)}</strong></div>
            <div class="tiny muted" style="margin-top:6px;">Elige una sola y hazla 2‚Äì5 minutos.</div>
          `;
          div.addEventListener("click", ()=>{
            $("#emPlanOut").textContent = `Elijo mi ancla: ${a}`;
            setEmergencyTab("calm");
          });
          list.appendChild(div);
        });
      }

      // People select
      const sel = $("#emPerson");
      const people = (state.kit.safePeople || []).filter(x=> String(x||"").trim());
      const current = sel.value;
      sel.innerHTML = `<option value="">‚Äî Elegir ‚Äî</option>`;
      people.forEach(p=>{
        const opt = document.createElement("option");
        opt.value = p; opt.textContent = p;
        sel.appendChild(opt);
      });
      if(people.includes(current)) sel.value = current;
      buildSupportMessage();
    }

    function buildSupportMessage(){
      const person = ($("#emPerson").value || "").trim();
      const intensity = Number(state.check.intensity ?? 0);
      const mood = state.mood ? state.mood : "algo dif√≠cil";
      const needNow = state.check.needNow ? state.check.needNow : "un poco de apoyo";
      const name = person ? person : "¬øme puedes apoyar?";
      const msg =
        `Hola ${name}. Ahorita me siento ${mood} (intensidad ${intensity}/10). ` +
        `¬øPodr√≠as acompa√±arme un momento? Solo necesito ${needNow}. ` +
        `Si puedes, ¬øme llamas o me respondes cuando tengas chance?`;
      $("#emMessage").value = msg;
    }

    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        setStatus("Copiado");
      }catch{
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        setStatus("Copiado");
      }
    }

    // ========= PIN =========
    function simpleHash(str){
      let h = 2166136261;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h>>>0).toString(16);
    }
    function getPinConfig(){
      const raw = localStorage.getItem(PIN_KEY);
      const cfg = safeParse(raw, null);
      if(!cfg || typeof cfg!=="object") return { enabled:false, pinHash:null };
      return { enabled: !!cfg.enabled, pinHash: cfg.pinHash || null };
    }
    function setPinConfig(cfg){ localStorage.setItem(PIN_KEY, JSON.stringify(cfg)); }
    function renderPinStatus(){
      const cfg = getPinConfig();
      $("#pinStatus").textContent = cfg.enabled
        ? "PIN: ACTIVADO ‚úÖ"
        : (cfg.pinHash ? "PIN guardado pero DESACTIVADO" : "PIN: no configurado");
    }
    function showLock(){
      $("#lockWrap").style.display="flex";
      $("#appMain").style.display="none";
      $("#footer").style.display="none";
      $("#lockMsg").textContent="‚Äî";
      $("#pinInput").value="";
    }
    function showApp(){
      $("#lockWrap").style.display="none";
      $("#appMain").style.display="grid";
      $("#footer").style.display="block";
    }
    function unlockAttempt(){
      const cfg = getPinConfig();
      const pin = ($("#pinInput").value||"").trim();
      if(!pin){ $("#lockMsg").textContent="Escribe tu PIN."; return; }
      if(simpleHash(pin) === cfg.pinHash){
        showApp();
        setStatus("Desbloqueado");
      }else{
        $("#lockMsg").textContent="PIN incorrecto.";
      }
    }

    // ========= EXPORT / IMPORT / WIPE =========
    function download(filename, text, mime="application/json;charset=utf-8"){
      const blob = new Blob([text], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href=url; a.download=filename;
      document.body.appendChild(a);
      a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function exportJSON(){
      const payload = { exportedAt: nowISO(), app:"Mi App Personal", version: state.version, data: state };
      const stamp = new Date().toISOString().slice(0,10);
      download(`mi-app-personal_${stamp}.json`, JSON.stringify(payload,null,2));
      setStatus("Exportado JSON");
    }

    function exportTXT(){
      const keys = Object.keys(state.history||{}).sort((a,b)=> a.localeCompare(b));
      const lines = [];
      lines.push("MI APP PERSONAL ‚Äî REGULACI√ìN EMOCIONAL");
      lines.push(`Exportado: ${new Date().toLocaleString("es-MX")}`);
      lines.push("");
      lines.push("=== HISTORIAL ===");
      lines.push("");

      if(!keys.length){
        lines.push("(No hay entradas guardadas)");
      }else{
        keys.forEach(k=>{
          const e = state.history[k];
          lines.push(`--- ${k} ---`);
          lines.push(`Estado: ${e.mood || "‚Äî"}`);
          lines.push(`Intensidad: ${(e.check?.intensity ?? "‚Äî")}/10`);
          lines.push(`Detonante: ${e.check?.trigger || "‚Äî"}${(e.check?.trigger==="Otro" && e.check?.triggerOther) ? " ("+e.check.triggerOther+")" : ""}`);
          lines.push(`Necesito: ${e.check?.needNow || "‚Äî"}`);
          lines.push(`Pensamiento: ${e.thought ? e.thought.replace(/\s+/g," ").trim() : "‚Äî"}`);
          lines.push(`Registro: ${e.event?.with || "‚Äî"}`);
          lines.push(`Notas: ${e.event?.notes ? e.event.notes.replace(/\s+/g," ").trim() : "‚Äî"}`);
          lines.push(`Frase (${labelNeed(e.need||"calma")}): ${e.quoteCurrent?.t || "‚Äî"}`);
          if(e.cbt?.alt){
            lines.push(`CBT alternativo: ${e.cbt.alt.replace(/\s+/g," ").trim()}`);
          }
          lines.push(`Guardado: ${e.savedAt ? formatDate(e.savedAt) : "‚Äî"}`);
          lines.push("");
        });
      }

      lines.push("");
      lines.push("=== FAVORITAS ===");
      lines.push("");
      if(!state.favorites.length){
        lines.push("(No hay favoritas)");
      }else{
        state.favorites.slice().sort((a,b)=> (a.addedAt||"").localeCompare(b.addedAt||""))
          .forEach(f=> lines.push(`‚Ä¢ [${labelNeed(f.need||"calma")}] "${f.t}" ‚Äî ${f.a||"An√≥nima"}`));
      }

      const stamp = new Date().toISOString().slice(0,10);
      download(`mi-app-personal_${stamp}.txt`, lines.join("\n"), "text/plain;charset=utf-8");
      setStatus("Exportado TXT");
    }

    async function importJSON(file){
      const text = await file.text();
      const payload = safeParse(text, null);
      const incoming = payload?.data ?? payload;
      if(!incoming || typeof incoming !== "object"){
        alert("Archivo inv√°lido.");
        return;
      }

      // mezcla segura
      state.version = incoming.version ?? state.version;
      state.mood = incoming.mood ?? state.mood;
      state.thought = incoming.thought ?? state.thought;
      state.thoughtSavedAt = incoming.thoughtSavedAt ?? state.thoughtSavedAt;

      if(incoming.event && typeof incoming.event==="object"){
        state.event.with = incoming.event.with ?? state.event.with;
        state.event.at = incoming.event.at ?? state.event.at;
        state.event.notes = incoming.event.notes ?? state.event.notes;
        state.event.savedAt = incoming.event.savedAt ?? state.event.savedAt;
      }

      state.need = incoming.need ?? state.need;
      state.quoteCurrent = incoming.quoteCurrent ?? state.quoteCurrent;
      state.favorites = Array.isArray(incoming.favorites) ? incoming.favorites : state.favorites;
      state.history = (incoming.history && typeof incoming.history==="object") ? incoming.history : state.history;
      state.lastOpenedDate = incoming.lastOpenedDate ?? state.lastOpenedDate;

      if(incoming.check && typeof incoming.check==="object"){
        state.check = {
          intensity: Number(incoming.check.intensity ?? 0) || 0,
          trigger: incoming.check.trigger ?? "",
          triggerOther: incoming.check.triggerOther ?? "",
          needNow: incoming.check.needNow ?? "",
          note: incoming.check.note ?? "",
          savedAt: incoming.check.savedAt ?? null
        };
      }
      if(incoming.cbt && typeof incoming.cbt==="object"){
        state.cbt = {
          auto: incoming.cbt.auto ?? "",
          emotion: incoming.cbt.emotion ?? "",
          fear: incoming.cbt.fear ?? "",
          for: incoming.cbt.for ?? "",
          against: incoming.cbt.against ?? "",
          alt: incoming.cbt.alt ?? "",
          savedAt: incoming.cbt.savedAt ?? null
        };
      }
      if(incoming.kit && typeof incoming.kit==="object"){
        state.kit = {
          anchors: Array.isArray(incoming.kit.anchors) ? incoming.kit.anchors : [],
          safePeople: Array.isArray(incoming.kit.safePeople) ? incoming.kit.safePeople : [],
          savedAt: incoming.kit.savedAt ?? null
        };
      }

      ensureCurrentQuote();
      save();
      renderAll();
      setStatus("Importado");
    }

    function wipeAll(){
      if(!confirm("¬øSeguro que quieres borrar TODO? Esto borra historial y favoritas.")) return;
      localStorage.removeItem(APP_KEY);

      state.mood=null;
      state.thought="";
      state.thoughtSavedAt=null;
      state.event={with:"",at:"",notes:"",savedAt:null};
      state.need="calma";
      state.quoteCurrent=null;
      state.favorites=[];
      state.history={};
      state.lastOpenedDate=null;

      state.check={intensity:0,trigger:"",triggerOther:"",needNow:"",note:"",savedAt:null};
      state.cbt={auto:"",emotion:"",fear:"",for:"",against:"",alt:"",savedAt:null};
      state.kit={anchors:[],safePeople:[],savedAt:null};

      ensureCurrentQuote();
      save();
      renderAll();
      setStatus("Borrado");
    }

    // ========= WIRE =========
    function wire(){
      // default date
      const today = toDateKey(new Date());
      $("#entryDate").value = state.lastOpenedDate || today;

      // Mood
      $$(".chip").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          state.mood = btn.getAttribute("data-mood");
          save(); renderMood();
          autoSaveDay();
        });
      });
      $("#clearMood").addEventListener("click", ()=>{
        state.mood=null;
        save(); renderMood();
        autoSaveDay();
      });

      // Thought
      $("#saveThought").addEventListener("click", ()=>{
        state.thought = $("#thought").value || "";
        state.thoughtSavedAt = nowISO();
        save(); renderThought();
        autoSaveDay();
      });
      $("#clearThought").addEventListener("click", ()=>{
        state.thought = "";
        state.thoughtSavedAt = nowISO();
        save(); renderThought();
        autoSaveDay();
      });

      // Check (1)
      $("#intensity").addEventListener("input", ()=>{
        const v = Number($("#intensity").value||0);
        $("#intensityVal").textContent = String(v);
      });
      $("#trigger").addEventListener("change", ()=>{
        const isOther = ($("#trigger").value === "Otro");
        $("#triggerOtherWrap").style.display = isOther ? "block" : "none";
        if(!isOther) $("#triggerOther").value = "";
      });

      $("#saveCheckBtn").addEventListener("click", ()=>{
        state.check.intensity = Number($("#intensity").value||0);
        state.check.trigger = $("#trigger").value || "";
        state.check.triggerOther = ($("#trigger").value==="Otro") ? ($("#triggerOther").value||"") : "";
        state.check.needNow = $("#needNow").value || "";
        state.check.note = $("#checkNote").value || "";
        state.check.savedAt = nowISO();

        save(); renderCheck();
        autoSaveDay();
        setStatus("Chequeo guardado");
      });

      $("#clearCheckBtn").addEventListener("click", ()=>{
        state.check = { intensity:0, trigger:"", triggerOther:"", needNow:"", note:"", savedAt: nowISO() };
        save(); renderCheck();
        autoSaveDay();
        setStatus("Chequeo limpio");
      });

      // Event
      $("#saveEvt").addEventListener("click", ()=>{
        state.event.with = $("#evtWith").value || "";
        state.event.at = $("#evtAt").value || "";
        state.event.notes = $("#evtNotes").value || "";
        state.event.savedAt = nowISO();
        save(); renderEvent();
        autoSaveDay();
      });
      $("#clearEvt").addEventListener("click", ()=>{
        state.event = { with:"", at:"", notes:"", savedAt: nowISO() };
        save(); renderEvent();
        autoSaveDay();
      });

      // Quotes
      $("#needSelect").addEventListener("change", ()=>{
        state.need = $("#needSelect").value || "calma";
        state.quoteCurrent = null;
        ensureCurrentQuote();
        save(); renderQuote();
        autoSaveDay();
        setStatus("Tema actualizado");
      });

      $("#newQuoteBtn").addEventListener("click", ()=>{
        ensureCurrentQuote();
        const prev = state.quoteCurrent?.t || null;
        state.quoteCurrent = pickRandomQuote(state.need, prev);
        save(); renderQuote();
        autoSaveDay();
        setStatus("Nueva frase");
      });

      // ‚ÄúGuardar frase‚Äù = guardar favorita r√°pida (y deja rastro)
      $("#saveQuoteBtn").addEventListener("click", ()=>{
        ensureCurrentQuote();
        const q = state.quoteCurrent;
        if(q){
          const exists = state.favorites.some(f=> f.t===q.t && f.need===q.need);
          if(!exists){
            state.favorites.push({ t:q.t, a:q.a, need:q.need, addedAt: nowISO() });
          }
        }
        save(); renderFavorites();
        autoSaveDay();
        setStatus("Frase guardada ‚≠ê");
      });

      $("#favQuoteBtn").addEventListener("click", ()=>{
        ensureCurrentQuote();
        const q = state.quoteCurrent;
        if(!q) return;
        const exists = state.favorites.some(f=> f.t===q.t && f.need===q.need);
        if(exists){ setStatus("Ya estaba en favoritas"); return; }
        state.favorites.push({ t:q.t, a:q.a, need:q.need, addedAt: nowISO() });
        save(); renderFavorites();
        autoSaveDay();
        setStatus("Guardada ‚≠ê");
      });

      $("#clearFavBtn").addEventListener("click", ()=>{
        if(!confirm("¬øEliminar TODAS las favoritas?")) return;
        state.favorites=[];
        save(); renderFavorites();
        setStatus("Favoritas limpias");
      });

      // CBT (3)
      $("#saveCbtBtn").addEventListener("click", ()=>{
        state.cbt.auto = $("#cbtAuto").value || "";
        state.cbt.emotion = $("#cbtEmotion").value || "";
        state.cbt.fear = $("#cbtFear").value || "";
        state.cbt.for = $("#cbtFor").value || "";
        state.cbt.against = $("#cbtAgainst").value || "";
        state.cbt.alt = $("#cbtAlt").value || "";
        state.cbt.savedAt = nowISO();
        save(); renderCbt();
        autoSaveDay();
        setStatus("CBT guardado");
      });

      $("#clearCbtBtn").addEventListener("click", ()=>{
        state.cbt = { auto:"", emotion:"", fear:"", for:"", against:"", alt:"", savedAt: nowISO() };
        save(); renderCbt();
        autoSaveDay();
        setStatus("CBT limpio");
      });

      // Kit (5)
      $("#saveKitBtn").addEventListener("click", ()=>{
        const anchors = ($("#anchors").value||"").split("\n").map(s=>s.trim()).filter(Boolean);
        const people = ($("#safePeople").value||"").split("\n").map(s=>s.trim()).filter(Boolean);
        state.kit.anchors = anchors;
        state.kit.safePeople = people;
        state.kit.savedAt = nowISO();
        save(); renderKit();
        setStatus("Kit guardado");
      });
      $("#clearKitBtn").addEventListener("click", ()=>{
        state.kit = { anchors:[], safePeople:[], savedAt: nowISO() };
        save(); renderKit();
        setStatus("Kit limpio");
      });

      // History
      $("#saveDayBtn").addEventListener("click", saveDayManual);
      $("#openDayBtn").addEventListener("click", ()=> openDay(getEntryDate()));
      $("#searchInput").addEventListener("input", renderHistory);

      // Pause
      $("#pauseBtn").addEventListener("click", openPause);
      $("#pauseCloseBtn").addEventListener("click", closePause);
      $("#pauseStartBtn").addEventListener("click", startPause);
      $("#pauseSwitchBtn").addEventListener("click", ()=>{
        pauseIdx++;
        updatePauseText();
        stopPause();
        $("#pauseTimer").textContent="30s";
      });

      // Emergency
      $("#emergencyBtn").addEventListener("click", openEmergency);
      $("#emCloseBtn").addEventListener("click", closeEmergency);

      $$(".tab").forEach(t=>{
        t.addEventListener("click", ()=> setEmergencyTab(t.getAttribute("data-tab")));
      });

      $("#emStart30").addEventListener("click", ()=>{
        closeEmergency();
        openPause();
      });

      $("#emMicroPlan").addEventListener("click", ()=>{
        const plan = MICRO_PLANS[Math.floor(Math.random()*MICRO_PLANS.length)];
        $("#emPlanOut").textContent = plan;
      });

      $("#emCopyGround").addEventListener("click", ()=> copyToClipboard($("#emGroundOut").textContent || ""));
      $("#emGroundNext").addEventListener("click", ()=>{
        groundIdx++;
        $("#emGroundOut").textContent = GROUND_GUIDES[groundIdx % GROUND_GUIDES.length];
      });

      $("#emPerson").addEventListener("change", buildSupportMessage);
      $("#emMsgRefresh").addEventListener("click", buildSupportMessage);
      $("#emCopyMsg").addEventListener("click", ()=> copyToClipboard($("#emMessage").value || ""));

      // Export / Import / Wipe
      $("#exportJsonBtn").addEventListener("click", exportJSON);
      $("#exportTxtBtn").addEventListener("click", exportTXT);
      $("#importFile").addEventListener("change", async (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        await importJSON(file);
        e.target.value="";
      });
      $("#wipeBtn").addEventListener("click", wipeAll);

      // PIN controls
      $("#setPinBtn").addEventListener("click", ()=>{
        const p1 = ($("#pinSet").value||"").trim();
        const p2 = ($("#pinSet2").value||"").trim();
        if(!p1 || !p2){ setStatus("Escribe y confirma el PIN"); return; }
        if(!/^\d+$/.test(p1)){ setStatus("PIN solo n√∫meros"); return; }
        if(p1 !== p2){ setStatus("No coincide"); return; }

        const cfg = getPinConfig();
        cfg.pinHash = simpleHash(p1);
        setPinConfig(cfg);
        $("#pinSet").value=""; $("#pinSet2").value="";
        renderPinStatus();
        setStatus("PIN guardado");
      });

      $("#togglePinBtn").addEventListener("click", ()=>{
        const cfg = getPinConfig();
        if(!cfg.pinHash){ alert("Primero guarda un PIN."); return; }
        cfg.enabled = !cfg.enabled;
        setPinConfig(cfg);
        renderPinStatus();
        setStatus(cfg.enabled ? "PIN activado" : "PIN desactivado");
        if(cfg.enabled) showLock();
      });

      $("#removePinBtn").addEventListener("click", ()=>{
        if(!confirm("¬øQuitar PIN?")) return;
        setPinConfig({ enabled:false, pinHash:null });
        renderPinStatus();
        setStatus("PIN eliminado");
        showApp();
      });

      // Lock screen
      $("#unlockBtn").addEventListener("click", unlockAttempt);
      $("#pinInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") unlockAttempt(); });

      $("#lockHelpBtn").addEventListener("click", ()=>{
        alert(
          "Si olvidaste el PIN:\n\n" +
          "‚Ä¢ Usa el bot√≥n: 'Quitar PIN (sin borrar historial)'\n" +
          "‚Ä¢ Luego puedes crear otro PIN desde Ajustes."
        );
      });

      $("#lockRemovePinBtn").addEventListener("click", ()=>{
        if(!confirm("Esto quitar√° el PIN y podr√°s entrar. NO borra tu historial. ¬øContinuar?")) return;
        localStorage.removeItem(PIN_KEY);
        setStatus("PIN eliminado");
        showApp();
      });

        // Service Worker
      if ("serviceWorker" in navigator) navigator.serviceWorker.register("sw.js");
    }

    // ========= BOOT =========
    load();
    if(!state.need) state.need="calma";
    ensureCurrentQuote();
    save();

    (function(){
      const cfg = getPinConfig();
      if(cfg.enabled && cfg.pinHash){ showLock(); return; }
      showApp();
    })();

    document.addEventListener("DOMContentLoaded", ()=>{
      renderAll();
      wire();
    });
  </script>
</body>
</html>
