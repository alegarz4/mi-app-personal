<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>Mi App Personal</title>

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icon.svg" type="image/svg+xml">

  <style>
    :root{
      --bg:#070b14;
      --panel:#0b1220;
      --panel2:#0d1a2c;
      --muted:#9aa6b2;
      --text:#e5e7eb;
      --border:rgba(255,255,255,.10);
      --shadow:0 18px 50px rgba(0,0,0,.45);
      --radius:22px;
      --brand:#7c3aed;
      --danger:#ef4444;
      --warn:#f59e0b;
      --ok:#22c55e;
      --chip:rgba(255,255,255,.06);
      --chipOn:rgba(124,58,237,.25);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(124,58,237,.25), transparent 55%),
        radial-gradient(900px 600px at 80% 30%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(900px 600px at 70% 85%, rgba(245,158,11,.12), transparent 55%),
        linear-gradient(180deg, #050914, #070b14 40%, #050914);
      color:var(--text);
      min-height:100vh;
    }

    header{
      position:sticky; top:0; z-index:50;
      background: linear-gradient(180deg, rgba(7,11,20,.95), rgba(7,11,20,.70));
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:18px 18px;}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:14px; flex-wrap:wrap;
    }
    .title h1{margin:0; font-size:28px; letter-spacing:.2px}
    .title p{margin:6px 0 0; color:var(--muted)}
    .right{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;}

    .status{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:999px;
      background: rgba(255,255,255,.04);
    }
    .dot{
      width:10px; height:10px; border-radius:99px; background:var(--ok);
      box-shadow:0 0 0 5px rgba(34,197,94,.15);
    }
    #statusText{color:var(--text); font-weight:600; font-size:14px}

    main{max-width:1100px; margin:0 auto; padding:18px;}
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:16px;
    }
    .card{
      grid-column: span 6;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(500px 260px at 10% 0%, rgba(124,58,237,.20), transparent 55%),
                  radial-gradient(500px 260px at 90% 0%, rgba(34,197,94,.14), transparent 55%);
      pointer-events:none;
      opacity:.75;
    }
    .card > *{position:relative}

    h2{margin:0 0 10px; font-size:22px}
    .muted{color:var(--muted)}
    .tiny{font-size:12px; color:var(--muted)}
    .divider{height:1px; background:var(--border); margin:14px 0}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .chip{
      border:1px solid var(--border);
      background: var(--chip);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:600;
      transition: transform .08s ease, background .15s ease;
      user-select:none;
    }
    .chip:hover{transform: translateY(-1px)}
    .chip.active{background: var(--chipOn); border-color: rgba(124,58,237,.35)}

    textarea, input, select{
      width:100%;
      background: rgba(0,0,0,.18);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px 12px;
      outline:none;
    }
    textarea{min-height:110px; resize:vertical}

    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      transition: transform .08s ease, background .15s ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.primary{background: rgba(124,58,237,.25); border-color: rgba(124,58,237,.40)}
    .btn.warn{background: rgba(245,158,11,.20); border-color: rgba(245,158,11,.35)}
    .btn.danger{background: rgba(239,68,68,.20); border-color: rgba(239,68,68,.38)}
    .btn.ghost{background: rgba(255,255,255,.03)}

    .two{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    .list{
      border:1px solid var(--border);
      border-radius:16px;
      background: rgba(0,0,0,.12);
      overflow:hidden;
    }
    .item{
      padding:12px 12px;
      border-top:1px solid var(--border);
    }
    .item:first-child{border-top:none}
    .item .meta{font-size:12px; color:var(--muted); margin-bottom:6px}
    .pill{
      display:inline-block;
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      margin-right:6px;
    }

    .overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      background: rgba(0,0,0,.55);
      z-index:999;
    }
    .modal{
      width:min(720px, 100%);
      border-radius:24px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(11,18,32,.96), rgba(11,18,32,.90));
      box-shadow: 0 30px 90px rgba(0,0,0,.65);
      padding:18px;
    }
    .modal h3{margin:0 0 10px; font-size:20px}
    .modalActions{display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; margin-top:14px}

    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .tab{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      font-weight:700;
    }
    .tab.active{background: rgba(124,58,237,.22); border-color: rgba(124,58,237,.35)}
    .tabPanel{margin-top:12px}

    footer{max-width:1100px; margin:0 auto; padding:14px 18px 28px; color:var(--muted)}

    /* FIX: Men√∫ desplegable visible en Chrome/Windows */
    select option {
      background: #111827 !important;
      color: #ffffff !important;
    }

    @media (max-width: 920px){
      .card{grid-column: span 12;}
      .two{grid-template-columns: 1fr}
    }
  </style>
</head>

<body>
<header>
  <div class="wrap top">
    <div class="title">
      <h1>Mi App Personal</h1>
      <p>Regulaci√≥n emocional: registrar, respirar, entender y avanzar (para todo, no para una sola historia).</p>
    </div>

    <div class="right">
      <button class="btn danger" id="emergencyBtn" type="button">üßØ Estoy muy mal</button>
      <button class="btn ghost" id="aboutBtn" type="button">‚ÑπÔ∏è Acerca de</button>

      <div class="status" aria-live="polite">
        <span class="dot"></span>
        <span id="statusText">Listo</span>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">

    <!-- MOOD -->
    <section class="card">
      <h2>¬øC√≥mo me siento hoy?</h2>
      <p class="muted">Elige una opci√≥n (o cambia cuando lo necesites).</p>

      <div class="row" id="moodRow">
        <button class="chip" data-mood="Tranquila" type="button">Tranquila</button>
        <button class="chip" data-mood="Ansiosa" type="button">Ansiosa</button>
        <button class="chip" data-mood="Triste" type="button">Triste</button>
        <button class="chip" data-mood="Indiferente" type="button">Indiferente</button>
        <button class="chip" data-mood="Molesta" type="button">Molesta</button>
      </div>

      <div class="divider"></div>

      <div class="row">
        <button class="btn warn" id="pause30Btn" type="button">‚è±Ô∏è Pausa 30s</button>
        <button class="btn ghost" id="clearMoodBtn" type="button">Limpiar</button>
      </div>

      <p class="tiny" style="margin-top:12px;">
        Tip: si est√°s ‚ÄúMolesta‚Äù o ‚ÄúAnsiosa‚Äù, usa ‚ÄúPausa 30s‚Äù antes de escribir. Baja la intensidad primero.
      </p>
    </section>

    <!-- THOUGHT -->
    <section class="card">
      <h2>¬øQu√© pensamiento domina?</h2>
      <p class="muted">Escr√≠belo tal cual. No es juicio, es registro.</p>

      <textarea id="thoughtInput" placeholder='Ej. ‚ÄúMe siento en alerta‚Ä¶‚Äù o ‚ÄúNecesito descansar‚Ä¶‚Äù'></textarea>

      <div class="row" style="margin-top:10px; justify-content:space-between;">
        <button class="btn primary" id="saveThoughtBtn" type="button">Guardar</button>
        <button class="btn ghost" id="clearThoughtBtn" type="button">Limpiar</button>
      </div>

      <div class="divider"></div>

      <div class="row" style="justify-content:space-between;">
        <span class="tiny">Fecha del registro</span>
        <input id="entryDate" type="date" style="max-width:220px" />
      </div>

      <p class="tiny" id="lastSavedInfo" style="margin-top:10px;"></p>
    </section>

    <!-- IMPORTANT LOG -->
    <section class="card">
      <h2>Registro importante</h2>
      <p class="muted">Aqu√≠ puedes registrar una llamada, un evento, o algo que movi√≥ tu d√≠a.</p>

      <textarea id="eventInput" placeholder="Ej. ‚ÄúTuve una conversaci√≥n dif√≠cil‚Äù, ‚ÄúMe sent√≠ mejor despu√©s de caminar‚Äù, etc."></textarea>

      <div class="row" style="margin-top:10px; justify-content:space-between;">
        <button class="btn primary" id="saveEventBtn" type="button">Guardar</button>
        <button class="btn ghost" id="clearEventBtn" type="button">Limpiar</button>
      </div>

      <div class="divider"></div>
      <div class="list" id="historyList" aria-label="Historial reciente"></div>
      <p class="tiny" style="margin-top:10px;">Se guarda solo en tu dispositivo (localStorage). No hay cuentas ni servidor.</p>
    </section>

    <!-- QUOTE -->
    <section class="card">
      <h2>Frase para ti</h2>
      <p class="muted">Elige lo que necesitas hoy. Si no te gusta la frase, c√°mbiala.</p>

      <div class="two" style="margin-top:10px;">
        <div>
          <label class="tiny" for="needSelect">Necesito hoy</label>
          <select id="needSelect">
            <option value="calma">Calma</option>
            <option value="autoestima">Autoestima</option>
            <option value="apoyo">Apoyo</option>
            <option value="claridad">Claridad</option>
            <option value="fuerza">Fuerza</option>
          </select>
        </div>
        <div>
          <label class="tiny" for="quoteAuthor">Autor (opcional)</label>
          <input id="quoteAuthor" placeholder="Ej. An√≥nimo / Maya Angelou / etc." />
        </div>
      </div>

      <div class="divider"></div>

      <div class="list">
        <div class="item">
          <div class="meta">
            <span class="pill" id="quoteNeedPill">calma</span>
            <span class="pill" id="quoteMoodPill">‚Äî</span>
          </div>
          <div style="font-size:18px; line-height:1.45; font-weight:800;" id="quoteText">‚Äî</div>
          <div class="tiny" id="quoteBy" style="margin-top:8px;"></div>
        </div>
      </div>

      <div class="row" style="margin-top:12px; justify-content:space-between;">
        <button class="btn primary" id="newQuoteBtn" type="button">üîÅ Cambiar frase</button>
        <button class="btn ghost" id="saveQuoteBtn" type="button">‚≠ê Guardar en favoritas</button>
      </div>

      <div class="divider"></div>
      <h3 style="margin:0 0 8px; font-size:16px;">Favoritas</h3>
      <div class="list" id="favoritesList"></div>
      <div class="row" style="margin-top:10px; justify-content:flex-end;">
        <button class="btn ghost" id="clearFavBtn" type="button">Borrar favoritas</button>
      </div>
    </section>

    <!-- BACKUP -->
    <section class="card">
      <h2>Respaldo</h2>
      <p class="muted">Descarga/recupera tu informaci√≥n. El archivo es <strong>JSON</strong> (un formato de texto para guardar datos).</p>

      <div class="row" style="margin-top:10px;">
        <button class="btn primary" id="exportBtn" type="button">‚¨áÔ∏è Exportar JSON</button>
        <label class="btn ghost" for="importFile" style="display:inline-flex; align-items:center; gap:8px;">
          ‚¨ÜÔ∏è Importar JSON
        </label>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>

      <div class="divider"></div>

      <p class="tiny">
        Importar reemplaza tu informaci√≥n actual por la del archivo. Si quieres, exporta primero.
      </p>
    </section>

  </div>
</main>

<footer class="wrap">
  Hecho para ti ‚ú® ‚Äî privado, offline, sin cuentas. <span class="tiny">Por Claudia Alejandra Garza Hernandez.</span>
</footer>

<!-- PAUSE MODAL -->
<div class="overlay" id="pauseOverlay" aria-hidden="true">
  <div class="modal">
    <h3>‚è±Ô∏è Pausa 30s</h3>
    <p class="muted" style="margin-top:0;">
      Respira. Suelta hombros. Inhala 4, sost√©n 2, exhala 6. Repite.
    </p>

    <div class="divider"></div>

    <div class="list">
      <div class="item">
        <div class="meta">Gu√≠a r√°pida</div>
        <div style="font-weight:800;">1) Pies en el suelo</div>
        <div class="tiny">2) Nombra 3 cosas que ves ¬∑ 2 que sientes ¬∑ 1 que puedes hacer ahora</div>
      </div>
    </div>

    <div class="modalActions">
      <button class="btn danger" id="pauseCloseBtn" type="button">Cerrar</button>
    </div>
  </div>
</div>

<!-- EMERGENCY MODAL -->
<div class="overlay" id="emergencyOverlay" aria-hidden="true">
  <div class="modal">
    <h3>üßØ Kit de emergencia</h3>
    <p class="muted" style="margin-top:0;">
      No tienes que resolverlo todo ahorita. Solo baja la intensidad y elige un paso peque√±o.
    </p>

    <div class="tabs">
      <button class="tab active" data-tab="calm" type="button">Bajan intensidad</button>
      <button class="tab" data-tab="ground" type="button">Aterrizar</button>
      <button class="tab" data-tab="anchors" type="button">Mis anclas</button>
      <button class="tab" data-tab="support" type="button">Pedir apoyo</button>
    </div>

    <div class="tabPanel" id="tabPanel"></div>

    <div class="modalActions">
      <button class="btn ghost" id="emStart30" type="button">‚è±Ô∏è Pausa 30s</button>
      <button class="btn danger" id="emCloseBtn" type="button">Cerrar</button>
    </div>
  </div>
</div>

<!-- ABOUT MODAL -->
<div class="overlay" id="aboutOverlay" aria-hidden="true">
  <div class="modal">
    <h3>‚ÑπÔ∏è Acerca de</h3>
    <p class="muted" style="margin-top:0;">
      <strong>Mi App Personal</strong> es una herramienta de regulaci√≥n emocional: registrar, respirar, entender y avanzar.
    </p>

    <div class="divider"></div>

    <p class="muted" style="margin:0;">
      <strong>Autor√≠a:</strong> Claudia Alejandra Garza Hernandez<br>
      <strong>¬©</strong> <span id="aboutYear"></span> ¬∑ Todos los derechos reservados.
    </p>

    <p class="tiny muted" style="margin-top:10px;">
      Esta app funciona offline y guarda la informaci√≥n solo en tu dispositivo (localStorage). No usa cuentas ni servidores.
    </p>

    <details>
      <summary>Licencia</summary>
      <p class="tiny muted">
        Prohibida la copia, modificaci√≥n o distribuci√≥n sin permiso por escrito de la autora.
      </p>
    </details>

    <div class="modalActions">
      <button class="btn ghost" id="aboutCopyBtn" type="button">Copiar autor√≠a</button>
      <button class="btn danger" id="aboutCloseBtn" type="button">Cerrar</button>
    </div>
  </div>
</div>

<script>
  // Helpers
  const $  = (sel)=> document.querySelector(sel);
  const $$ = (sel)=> Array.from(document.querySelectorAll(sel));
  const KEY = "mi_app_personal_v2";

  function setStatus(msg){
    const el = $("#statusText");
    if (el) el.textContent = msg;
  }

  function nowISO(){ return new Date().toISOString(); }
  function toDateKey(d){
    const x = new Date(d);
    const y = x.getFullYear();
    const m = String(x.getMonth()+1).padStart(2,"0");
    const day = String(x.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  // State
  const state = load() || {
    mood: null,
    lastOpenedDate: toDateKey(new Date()),
    days: {},        // { "YYYY-MM-DD": { mood, thought, event, updatedAt } }
    favorites: [],   // { t, a, need, addedAt }
    quoteCurrent: null
  };

  function save(){
    localStorage.setItem(KEY, JSON.stringify(state));
  }

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      return raw ? JSON.parse(raw) : null;
    }catch(e){ return null; }
  }

  function ensureDay(dateKey){
    if (!state.days[dateKey]) state.days[dateKey] = { mood:null, thought:"", event:"", updatedAt:null };
    return state.days[dateKey];
  }

  // Quotes (muchas, por categor√≠a)
  const QUOTES = {
    calma: [
      {t:"Respira. Esto tambi√©n pasar√°.", a:"An√≥nimo"},
      {t:"Haz las paces con el minuto que est√°s viviendo.", a:"An√≥nimo"},
      {t:"Un paso peque√±o sigue siendo un paso.", a:"An√≥nimo"},
      {t:"No tienes que hacer todo hoy. Solo lo siguiente.", a:"An√≥nimo"},
      {t:"La calma no es ausencia de caos; es presencia de ti.", a:"An√≥nimo"},
      {t:"Tu mente grita, pero tu cuerpo puede volver al presente.", a:"An√≥nimo"}
    ],
    autoestima: [
      {t:"Eres m√°s que tu peor d√≠a.", a:"An√≥nimo"},
      {t:"Habla contigo como hablar√≠as con alguien que amas.", a:"An√≥nimo"},
      {t:"Tu valor no depende de tu productividad.", a:"An√≥nimo"},
      {t:"No naciste para encogerte.", a:"An√≥nimo"},
      {t:"Hay una versi√≥n de ti que ya sobrevivi√≥ a esto.", a:"An√≥nimo"},
      {t:"Tu historia merece ternura.", a:"An√≥nimo"}
    ],
    apoyo: [
      {t:"Pedir ayuda tambi√©n es fuerza.", a:"An√≥nimo"},
      {t:"No tienes que cargarlo sola.", a:"An√≥nimo"},
      {t:"Un mensaje a la persona correcta puede cambiar tu d√≠a.", a:"An√≥nimo"},
      {t:"A veces, sostenerte es dejarte sostener.", a:"An√≥nimo"},
      {t:"Estoy contigo: una cosa a la vez.", a:"An√≥nimo"},
      {t:"Tu dolor merece cuidado, no silencio.", a:"An√≥nimo"}
    ],
    claridad: [
      {t:"No decidas en medio de la tormenta.", a:"An√≥nimo"},
      {t:"Lo que hoy parece confuso, ma√±ana ser√° aprendizaje.", a:"An√≥nimo"},
      {t:"Escribe: lo que nombras, se ordena.", a:"An√≥nimo"},
      {t:"Primero calma, luego claridad.", a:"An√≥nimo"},
      {t:"Tu intuici√≥n se escucha mejor cuando bajas el ruido.", a:"An√≥nimo"},
      {t:"Elige el siguiente paso, no el final de la historia.", a:"An√≥nimo"}
    ],
    fuerza: [
      {t:"Has sobrevivido a d√≠as dif√≠ciles antes. Puedes hoy.", a:"An√≥nimo"},
      {t:"La valent√≠a tambi√©n tiembla.", a:"An√≥nimo"},
      {t:"Sigue, aunque sea despacio.", a:"An√≥nimo"},
      {t:"Tu fortaleza no se ve en el silencio: se ve en que sigues aqu√≠.", a:"An√≥nimo"},
      {t:"No te rindas con la versi√≥n cansada de ti.", a:"An√≥nimo"},
      {t:"Hoy cuenta. T√∫ cuentas.", a:"An√≥nimo"}
    ]
  };

  const GROUND_GUIDES = [
    "Nombra 5 cosas que ves, 4 que sientes, 3 que escuchas, 2 que hueles, 1 que saboreas.",
    "Presiona tus pies contra el suelo 10 segundos. Suelta. Repite 3 veces.",
    "Toca una superficie fr√≠a. Describe su textura con detalle.",
    "Mueve tu cuello suave: izquierda, derecha. Suelta mand√≠bula."
  ];

  function pick(arr){
    return arr[Math.floor(Math.random()*arr.length)];
  }

  function ensureCurrentQuote(){
    const need = $("#needSelect")?.value || "calma";
    const pool = QUOTES[need] || QUOTES.calma;
    const q = pick(pool);
    state.quoteCurrent = { t:q.t, a:q.a, need };
    save();
  }

  function renderQuote(){
    const q = state.quoteCurrent;
    if (!q){
      ensureCurrentQuote();
    }
    const qq = state.quoteCurrent;
    $("#quoteText").textContent = qq.t;
    $("#quoteNeedPill").textContent = qq.need;
    $("#quoteMoodPill").textContent = state.mood || "‚Äî";
    const authorInput = $("#quoteAuthor")?.value?.trim();
    const by = authorInput ? authorInput : (qq.a || "An√≥nimo");
    $("#quoteBy").textContent = by ? "‚Äî " + by : "";
  }

  function renderMood(){
    $$("#moodRow .chip").forEach(btn=>{
      btn.classList.toggle("active", btn.getAttribute("data-mood") === state.mood);
    });
  }

  function renderHistory(){
    const list = $("#historyList");
    if (!list) return;
    const keys = Object.keys(state.days || {}).sort().reverse().slice(0, 12);

    if (keys.length === 0){
      list.innerHTML = `<div class="item"><div class="meta">A√∫n no hay registros</div><div class="tiny">Cuando guardes un pensamiento o evento, aparecer√° aqu√≠.</div></div>`;
      return;
    }

    list.innerHTML = keys.map(k=>{
      const d = state.days[k];
      const mood = d.mood || "‚Äî";
      const thought = (d.thought || "").trim();
      const event = (d.event || "").trim();
      const updated = d.updatedAt ? new Date(d.updatedAt).toLocaleString() : "";
      return `
        <div class="item">
          <div class="meta"><span class="pill">${k}</span><span class="pill">${mood}</span> ${updated ? "¬∑ " + updated : ""}</div>
          ${thought ? `<div><strong>Pensamiento:</strong> ${escapeHtml(thought)}</div>` : `<div class="tiny muted">Sin pensamiento</div>`}
          ${event ? `<div style="margin-top:6px;"><strong>Evento:</strong> ${escapeHtml(event)}</div>` : ""}
        </div>
      `;
    }).join("");
  }

  function renderFavorites(){
    const box = $("#favoritesList");
    if (!box) return;
    const favs = state.favorites || [];
    if (!favs.length){
      box.innerHTML = `<div class="item"><div class="tiny muted">A√∫n no tienes favoritas.</div></div>`;
      return;
    }
    box.innerHTML = favs.slice().reverse().map(f=>{
      const when = f.addedAt ? new Date(f.addedAt).toLocaleString() : "";
      return `
        <div class="item">
          <div class="meta"><span class="pill">${escapeHtml(f.need||"")}</span> ${when}</div>
          <div style="font-weight:800;">${escapeHtml(f.t)}</div>
          ${f.a ? `<div class="tiny">${escapeHtml(f.a)}</div>` : ""}
        </div>
      `;
    }).join("");
  }

  function renderAll(){
    // date
    const today = toDateKey(new Date());
    $("#entryDate").value = state.lastOpenedDate || today;

    // restore day fields
    const day = ensureDay($("#entryDate").value);
    state.mood = day.mood || state.mood || null;
    $("#thoughtInput").value = day.thought || "";
    $("#eventInput").value = day.event || "";

    renderMood();
    ensureCurrentQuote();
    renderQuote();
    renderHistory();
    renderFavorites();

    $("#lastSavedInfo").textContent = day.updatedAt ? `√öltimo guardado: ${new Date(day.updatedAt).toLocaleString()}` : "";
  }

  function autoSaveDay(){
    const dateKey = $("#entryDate").value || toDateKey(new Date());
    const d = ensureDay(dateKey);
    d.mood = state.mood || null;
    d.thought = $("#thoughtInput").value || "";
    d.event = $("#eventInput").value || "";
    d.updatedAt = nowISO();
    save();
    $("#lastSavedInfo").textContent = `√öltimo guardado: ${new Date(d.updatedAt).toLocaleString()}`;
  }

  function openOverlay(id){
    const ov = $(id);
    if (!ov) return;
    ov.style.display = "flex";
    ov.setAttribute("aria-hidden","false");
  }
  function closeOverlay(id){
    const ov = $(id);
    if (!ov) return;
    ov.style.display = "none";
    ov.setAttribute("aria-hidden","true");
  }

  function copyToClipboard(txt){
    if (navigator.clipboard?.writeText){
      navigator.clipboard.writeText(txt).then(()=> setStatus("Copiado ‚úÖ")).catch(()=> setStatus("No se pudo copiar"));
    }else{
      setStatus("Copia no disponible");
    }
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // Emergency tabs
  function setEmergencyTab(tab){
    $$("#emergencyOverlay .tab").forEach(b=>{
      b.classList.toggle("active", b.getAttribute("data-tab") === tab);
    });

    const panel = $("#tabPanel");
    if (!panel) return;

    if (tab === "calm"){
      panel.innerHTML = `
        <div class="list">
          <div class="item">
            <div class="meta">1 minuto</div>
            <div style="font-weight:900;">Inhala 4 ¬∑ sost√©n 2 ¬∑ exhala 6 (x5)</div>
            <div class="tiny">Suaviza mand√≠bula, baja hombros.</div>
          </div>
          <div class="item">
            <div class="meta">Bajar intensidad</div>
            <div class="tiny">Agua fr√≠a en mu√±ecas / cara ¬∑ camina 2 minutos ¬∑ nombra lo que sientes sin juzgar.</div>
          </div>
        </div>
      `;
    } else if (tab === "ground"){
      panel.innerHTML = `
        <div class="list">
          <div class="item">
            <div class="meta">Aterrizar</div>
            <div style="font-weight:900;">${escapeHtml(pick(GROUND_GUIDES))}</div>
            <div class="tiny">Repite si lo necesitas.</div>
          </div>
        </div>
      `;
    } else if (tab === "anchors"){
      panel.innerHTML = `
        <div class="list">
          <div class="item">
            <div class="meta">Mis anclas</div>
            <div class="tiny">Escribe 1 cosa que s√≠ controlas hoy (aunque sea peque√±a).</div>
            <textarea id="emAnchor" placeholder="Ej. ‚ÄúTomar agua‚Äù, ‚ÄúBa√±arme‚Äù, ‚ÄúEnviar un mensaje‚Äù, ‚ÄúSalir a caminar‚Äù"></textarea>
            <div class="row" style="margin-top:10px; justify-content:flex-end;">
              <button class="btn primary" id="emSaveAnchor" type="button">Guardar en evento</button>
            </div>
          </div>
        </div>
      `;
      // wire anchor button
      setTimeout(()=>{
        const b = $("#emSaveAnchor");
        if (b) b.addEventListener("click", ()=>{
          const t = $("#emAnchor")?.value?.trim();
          if (!t) return;
          const prev = $("#eventInput").value?.trim();
          $("#eventInput").value = prev ? (prev + "\n‚Ä¢ " + t) : ("‚Ä¢ " + t);
          autoSaveDay();
          setStatus("Ancla guardada ‚≠ê");
        });
      }, 0);
    } else if (tab === "support"){
      panel.innerHTML = `
        <div class="list">
          <div class="item">
            <div class="meta">Mensaje sugerido</div>
            <div style="font-weight:900;">‚ÄúHola, ¬øme puedes acompa√±ar un momento? No necesito soluciones, solo compa√±√≠a.‚Äù</div>
            <div class="row" style="margin-top:10px; justify-content:flex-end;">
              <button class="btn ghost" id="emCopyMsg" type="button">Copiar mensaje</button>
            </div>
          </div>
        </div>
      `;
      setTimeout(()=>{
        const b = $("#emCopyMsg");
        if (b) b.addEventListener("click", ()=> copyToClipboard("Hola, ¬øme puedes acompa√±ar un momento? No necesito soluciones, solo compa√±√≠a."));
      }, 0);
    }
  }

  // Wire all
  function wire(){
    // default date
    const today = toDateKey(new Date());
    $("#entryDate").value = state.lastOpenedDate || today;

    // date change
    $("#entryDate").addEventListener("change", ()=>{
      state.lastOpenedDate = $("#entryDate").value;
      const d = ensureDay(state.lastOpenedDate);
      state.mood = d.mood || null;
      $("#thoughtInput").value = d.thought || "";
      $("#eventInput").value = d.event || "";
      renderMood();
      renderQuote();
      renderHistory();
      $("#lastSavedInfo").textContent = d.updatedAt ? `√öltimo guardado: ${new Date(d.updatedAt).toLocaleString()}` : "";
      save();
      setStatus("Fecha cambiada");
    });

    // mood chips
    $$("#moodRow .chip").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        state.mood = btn.getAttribute("data-mood");
        renderMood();
        autoSaveDay();
        setStatus("Estado guardado");
      });
    });

    $("#clearMoodBtn").addEventListener("click", ()=>{
      state.mood = null;
      renderMood();
      autoSaveDay();
      setStatus("Mood limpio");
    });

    // thought
    $("#saveThoughtBtn").addEventListener("click", ()=>{
      autoSaveDay();
      renderHistory();
      setStatus("Guardado");
    });
    $("#clearThoughtBtn").addEventListener("click", ()=>{
      $("#thoughtInput").value = "";
      autoSaveDay();
      renderHistory();
      setStatus("Borrado");
    });

    // event
    $("#saveEventBtn").addEventListener("click", ()=>{
      autoSaveDay();
      renderHistory();
      setStatus("Guardado");
    });
    $("#clearEventBtn").addEventListener("click", ()=>{
      $("#eventInput").value = "";
      autoSaveDay();
      renderHistory();
      setStatus("Borrado");
    });

    // quote
    $("#needSelect").addEventListener("change", ()=>{
      ensureCurrentQuote();
      renderQuote();
      setStatus("Frase actualizada");
    });

    $("#newQuoteBtn").addEventListener("click", ()=>{
      ensureCurrentQuote();
      renderQuote();
      setStatus("Nueva frase");
    });

    // ‚ÄúGuardar frase‚Äù = favorita
    $("#saveQuoteBtn").addEventListener("click", ()=>{
      ensureCurrentQuote();
      const q = state.quoteCurrent;
      if (q){
        const authorInput = $("#quoteAuthor")?.value?.trim();
        const a = authorInput ? authorInput : (q.a || "");
        const exists = (state.favorites || []).some(f=> f.t===q.t && f.need===q.need);
        if (!exists){
          state.favorites.push({ t:q.t, a, need:q.need, addedAt: nowISO() });
          save();
          renderFavorites();
          setStatus("Frase guardada ‚≠ê");
        }else{
          setStatus("Ya estaba en favoritas");
        }
      }
    });

    $("#clearFavBtn").addEventListener("click", ()=>{
      if (!confirm("¬øBorrar todas las favoritas?")) return;
      state.favorites = [];
      save();
      renderFavorites();
      setStatus("Favoritas borradas");
    });

    // Pause
    $("#pause30Btn").addEventListener("click", ()=> openOverlay("#pauseOverlay"));
    $("#pauseCloseBtn").addEventListener("click", ()=> closeOverlay("#pauseOverlay"));
    $("#pauseOverlay").addEventListener("click", (e)=>{ if (e.target.id==="pauseOverlay") closeOverlay("#pauseOverlay"); });

    // Emergency
    $("#emergencyBtn").addEventListener("click", ()=>{
      openOverlay("#emergencyOverlay");
      setEmergencyTab("calm");
    });
    $("#emCloseBtn").addEventListener("click", ()=> closeOverlay("#emergencyOverlay"));
    $("#emergencyOverlay").addEventListener("click", (e)=>{ if (e.target.id==="emergencyOverlay") closeOverlay("#emergencyOverlay"); });

    $$("#emergencyOverlay .tab").forEach(t=>{
      t.addEventListener("click", ()=> setEmergencyTab(t.getAttribute("data-tab")));
    });

    $("#emStart30").addEventListener("click", ()=>{
      closeOverlay("#emergencyOverlay");
      openOverlay("#pauseOverlay");
    });

    // About (autor√≠a)
    $("#aboutBtn").addEventListener("click", ()=>{
      $("#aboutYear").textContent = new Date().getFullYear();
      openOverlay("#aboutOverlay");
    });
    $("#aboutCloseBtn").addEventListener("click", ()=> closeOverlay("#aboutOverlay"));
    $("#aboutOverlay").addEventListener("click", (e)=>{ if (e.target.id==="aboutOverlay") closeOverlay("#aboutOverlay"); });

    $("#aboutCopyBtn").addEventListener("click", ()=>{
      const txt =
        "Mi App Personal ‚Äî Autor√≠a: Claudia Alejandra Garza Hernandez. ¬© " +
        new Date().getFullYear() +
        " Claudia Alejandra Garza Hernandez. Todos los derechos reservados.";
      copyToClipboard(txt);
    });

    // Export / Import JSON
    $("#exportBtn").addEventListener("click", ()=>{
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `mi-app-personal-respaldo-${toDateKey(new Date())}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setStatus("Respaldo descargado");
    });

    $("#importFile").addEventListener("change", async (e)=>{
      const file = e.target.files?.[0];
      if (!file) return;
      if (!confirm("Importar reemplazar√° tu informaci√≥n actual. ¬øContinuar?")){ e.target.value=""; return; }

      try{
        const text = await file.text();
        const obj = JSON.parse(text);
        // m√≠nima validaci√≥n
        if (!obj || typeof obj !== "object") throw new Error("Formato inv√°lido");
        localStorage.setItem(KEY, JSON.stringify(obj));
        location.reload();
      }catch(err){
        alert("No se pudo importar ese archivo. Aseg√∫rate de que sea un JSON de esta app.");
      }finally{
        e.target.value="";
      }
    });

    // Service Worker
    if ("serviceWorker" in navigator) navigator.serviceWorker.register("sw.js");
  }

  // Boot
  (function(){
    // fecha por si cambia de d√≠a
    const today = toDateKey(new Date());
    if (!state.lastOpenedDate) state.lastOpenedDate = today;
    ensureDay(state.lastOpenedDate);
    save();
    renderAll();
  })();

  document.addEventListener("DOMContentLoaded", ()=>{
    wire();
  });
</script>

</body>
</html>
2) ‚úÖ sw.js (reemplaza tu sw.js completo)
Copiar c√≥digo
Js
const CACHE = "mi-app-personal-cache-v2";
const ASSETS = [
  "./",
  "./index.html",
  "./manifest.webmanifest",
  "./icon.svg",
  "./sw.js"
];

self.addEventListener("install", (e)=>{
  e.waitUntil(
    caches.open(CACHE).then(c=>c.addAll(ASSETS)).then(()=>self.skipWaiting())
  );
});

self.addEventListener("activate", (e)=>{
  e.waitUntil(
    caches.keys().then(keys=>Promise.all(keys.map(k=> k!==CACHE ? caches.delete(k) : null )))
      .then(()=>self.clients.claim())
  );
});

self.addEventListener("fetch", (e)=>{
  e.respondWith(
    caches.match(e.request).then(cached=>{
      return cached || fetch(e.request).then(resp=>{
        const copy = resp.clone();
        caches.open(CACHE).then(c=>c.put(e.request, copy));
        return resp;
      }).catch(()=>cached);
    })
  );
});
3) ‚úÖ manifest.webmanifest (reemplaza completo)
Copiar c√≥digo
Json
{
  "name": "Mi App Personal",
  "short_name": "Mi App",
  "start_url": "./",
  "scope": "./",
  "display": "standalone",
  "background_color": "#0b1220",
  "theme_color": "#0b1220",
  "icons": [
    {
      "src": "icon.svg",
      "sizes": "512x512",
      "type": "image/svg+xml",
      "purpose": "any"
    }
  ]
}

